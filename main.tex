\documentclass[12pt]{amsart}

\title{Mathematical Finance in discrete time}
\author{Elias Mindlberger}
\date{Winter Semester 2025/26}

\input{macros}
\input{style}

\begin{document}

\maketitle

\tableofcontents
\bigskip

\section{Introduction and first example}

We start by introducing the first important notions of option pricing and first examples.

\subsection{Notions for option pricing theory}

An \textbf{option} is a contract between two parties (a buyer and a seller). The buyer pays an option price \emph{today} (i.e.\ at \(t=0\)) to the seller and in return obtains the right/\emph{option} \underline{but not the obligation} to buy a stock for conditions that are fixed \emph{today} at a fixed point in time (\emph{the maturity of the option}).
The option to buy is thereby crucial: the buyer can just refrain from buying the stock if te market conditions are disadvantageous.

We only consider options whose \emph{underlyings (german: Basistitel)} are stocks.\newpage

We distinguish the following:

\begin{tikzpicture}[>=stealth, thick]
    % Arrows for call and put
    \draw[->] (-3,0) -- (3,2);
    \draw[->] (-3,0) -- (3,-2);

    % Labels
    \node at (4.5,2) {\textbf{Call option}};
    \node at (4.5,-2) {\textbf{Put option}};

    % Text below arrows
    \node[align=left] at (6,1) {Buyer has the right to \underline{buy} \\ the stock for the \emph{strike price} \(K\).};
    \node[align=left] at (6,-3) {Buyer has the right to \underline{sell} \\ the stock for the \emph{strike price} \(K\).};

    % Arrows for call and put
    \draw[->] (-3,-7) -- (3,-5);
    \draw[->] (-3,-7) -- (3,-9);

    % Labels
    \node at (5,-5) {\textbf{European option}};
    \node at (5,-9) {\textbf{American option}};

    % Text below arrows
    \node[align=left] at (6.5,-5.7) {Can only be exercised at maturity \(T\).};
    \node[align=left] at (6.5,-9.7) {Can be exercised at \(t\) s.t.\ \(0 \leq t \leq T\).};
\end{tikzpicture}

We call the above \textbf{standard} or \textbf{vanilla} options. Other options are called \textbf{exotic}. Such include \emph{Asian options} (which operate on the mean--value of an asset), \emph{barrier options}, \emph{options on volatility} and so forth. For this course we assume that options have a price at any point in time \(0 \leq t \leq T\). Advantages of options include
\begin{itemize}
    \item The loss is limited: worst case is the loss of the option price,
    \item leverage effect (in a positive market development),
    \item can be used to \emph{hedge} against decreasing stock prices via put options (can be sold for a fixed pre--determined price).
\end{itemize}

\subsection{A first example}

Let us consider a call option in a two--period market model. We set
\begin{itemize}
    \item \(t=0\): the current time or today,
    \item \(T>0\): the maturity or exercise date of the option,
    \item \(S_T\): random price of the underlying stock at time \(T\),
    \item \(S_0\): known price of the underlying stock at time \(t=0\),
    \item \(K\): the strike price.
\end{itemize}

\begin{remark}
    No physical transaction of the stock at time \(T\) happens. Only the profit is paid out accordingly.
\end{remark}
Clearly, the \textbf{payoff} for a call option at time \(T\) is \[
    H = \max \set{S_T-K, 0} = \left(S_T-K\right)^+.
\]
\(H\) itself is a random variable since \(S_T\) is assumed to be random.


\begin{center}
    \begin{tikzpicture}
        \begin{axis}[
            axis lines=middle,
            samples=200,
            domain=-1:4,
            ymin=-0.5, ymax=3,
            xmin=-1, xmax=4,
            axis line style={->, thick},
            xtick=\empty,
            ytick=\empty,
            xlabel={\(S_T\)},
            ylabel={Payoff},
            width=8cm,
            height=6cm
        ]

        % Dashed part for x < K
        \addplot[blue, ultra thick, dashed, domain=-1:1.5] {0};

        % Solid part for x >= K
        \addplot[blue, ultra thick, domain=1.5:4] {x-1.5};

        % Mark K
        \draw[dashed, gray] (axis cs:1.5,0) -- (axis cs:1.5,1.5);
        \filldraw[black] (axis cs:1.5,0) circle (1.5pt) node[below] {\(K\)};

        % Function label
        \node[blue, above right] at (axis cs:3,1) {\(H\)};

        \end{axis}
    \end{tikzpicture}

    \vspace{0.5em}
    \small\textbf{Figure:} Visualisation of the payoff \(H\) dependent on the strike \(K\).
\end{center}

Take \(S_0=100\) and assume the stock can attain two prices at \(T\). Either it attains \(150\) in the case of \(\omega_1\) or it attains \(90\) in the case of \(\omega_2\), i.e.\ \(S_T(\omega_1) = 150\) and \(S_T(\omega_2) = 90\) with probabilities \(p\) and \(1-p\) respectively. We let \(130\) be the strike \(K\). The payoff is obviously \(20\) and \(0\) respectively. We assume that there is an additional, riskless investment opportunity with interest rate \(r=0\).

\textbf{Question.} What is the fair price \(\pi(H)\) of the above option at \(t=0\)?

\textbf{Idea: No--arbitrage--principle.}
There is no arbitrage (i.e.\ no riskless profit) in the financial market.

The payoff \(H\) is replicated by other assets (in this case stocks and riskless investments).

The initial capital that is needed in order to replicate \(H\) corresponds to the price of the option. Otherwise, there is arbitrage.

We now want to find a \textbf{trading strategy} \((\alpha, \beta) \in \R^2\) with
\begin{itemize}
    \item \(\alpha\), the number of stocks that we buy at \(t=0\),
    \item \(\beta\), the investment in the riskless asset (RA).
\end{itemize}

The value of the portfolio at \(t=0\) is \(V_0(\alpha, \beta) = \beta \cdot 1 + \alpha S_0\) (the RA is normalised) and the value of the portfolio at \(t=T\) is \(V_T(\alpha, \beta) = \beta \cdot 1 + \alpha S_T\) (recall \(r=0\)). We want to \emph{hedge} or \emph{replicate} the payoff, i.e.\ choose \((\alpha, \beta)\) such that \(V_T(\alpha, \beta) = H\). This means \(\beta+\alpha S_T(\omega) = H(\omega)\) for any \(\omega \in \set{\omega_1, \omega_2}\). Hence, we get a system of linear equations.

\begin{align*}
    \beta + 150\alpha &= 20\\
    \beta + 90 \alpha &= -0.
\end{align*}
Solving this for \(\alpha, \beta\) yields \(\alpha=1/3\) and \(\beta=-30\). Hence \[
    V_0(\alpha, \beta) = -30 + 100/3 = 10/3 = \pi(H).
\]
The hedging strategy that we get is to borrow \(30\) today and buy \(1/3\) stocks. The overall investment is \(10/3\). Two scenarios can happen at \(t=T\):
\begin{enumerate}
    \item \(S_T=150\). Selling the stock yields \(1/3 \cdot 150 = 50\). We repay our debt of \(30\) and yield \(20\) as profit.
    \item \(S_T=90\). Selling the stock yields \(1/3 \cdot 90 = 30\). We repay the debt and nothing happens.
\end{enumerate}
As we see, we hedged \(H\) perfectly. Now assume that we \underline{sell} the call option at a price of \(10/3\) and invest. Then, the following can happen.

\begin{enumerate}
    \item \(S_T=150\). The buyer will exercise the call, he or she will buy the stock for \(130\) from us,
    \item we have to buy the stock for \(150\), we lose \(20\),
    \item but we obtain \(20\) as by hedging in (1).
\end{enumerate}

\begin{enumerate}
    \item \(S_T=90\). Goes analogously.
\end{enumerate}

Using the no--arbitrage--principle, the fair price of the option is \(\pi(H)=10/3\). For any other price, a riskless profit would be possible. Assume \(\pi(H) > 10/3\). Then we get the following table:

\begin{table}[h!]
    \centering
        \begin{tabular}{ll}
            \toprule
            \textbf{Action at \(t=0\)} & \textbf{Payoff at \(t=T\)} \\
            \midrule
            Sell \(\pi(H)\) & \(-(S_T-K)^+\)\\
            Borrow \(30\) RA & \(-30\)\\
            Buy \(S_0/3\) & \(S_T/3\)\\
            Profit: \(\pi(H)+30-S_0/3=\pi(H)-10/3>0\) & \(\Sigma=0\) \\
            \bottomrule
        \end{tabular}
    \caption{Unfair pricing shows the possibility of riskless profit.}
\end{table}

Assume now \(\pi(H) < 10/3\). The table goes analogous to the above.

\begin{remark}
    Notice that the fair price \(\pi(H)\) in this example is \textbf{independent} of the subjective probability \(p\)! In more sophisticated models, we will also adapt to this.
\end{remark}

\subsection{Market assumptions}

In this section, we used a perfect market model.
\begin{itemize}
    \item The markets are frictionless, i.e.\ there are no taxes on profits and no transaction costs for reallocating portfolios,
    \item short--selling is allowed at all times and arbitrary shares can be bought and sold,
    \item interest rates for borrowing and lending are te same as well as investments in RA,
    \item there are no dividend payments,
    \item all market participants are rational and maximise their utility.
\end{itemize}

In a perfect market there is no arbitrage. Supply and demand offset each other perfectly and there are unique prices.

\newpage
\section{Financial markets and the finite state space}

Our goal here is to introduce general financial markets. Finite means that there is a finite number of market states and a finite number of trading times \(\set{0, \dots, T}\). We describe trading strategies, arbitrage strategies and options formally.

\subsection{Definition of the financial market}

We take \((\Omega, \cF, (\cF_t)_{t}, \P)\) to be a filtered probability space. I.e.\
\begin{itemize}
    \item \(\Omega\) is a finite state space of elementary events,
    \item \(\cF\) is the power set of \(\Omega\) and acts as the \(\sigma\)-algebra,
    \item \((\cF_t)_t\) is a filtration,
    \item \(\P: \cF \to [0, 1]\) is a probability measure.
\end{itemize}

\begin{remark}
    We remark that for a probability space \((\Omega, \cF, \P)\) and an \underline{ordered} index set \(I\), a family of \(\cF\)-sub-\(\sigma\)-algebras \((\cF_i)_{i \in I}\) is a filtration if and only if for any \(t, s \in I: t \leq s \implies \cF_t \subseteq \cF_s\). Since our index sets \(I\) are always finite with maximal element \(T\), we make the additional presumption that \(\cF = \cF_T\).
\end{remark}

A \textbf{financial market} consists of \(d+1\) investment opportunities: one \textbf{riskless asset} with a deterministic price process \((B_t) = (B_0, \dots, B_T)\), i.e.\ imagine a savings account such that \(B_0 = 1\) and \(B_{t+1} \geq B_t\) for \(t = 1, \dots, T\). \(B_t\) is the value at the time \(t\) of \(1\) such unit that has been invested at \(t=0\), e.g.\ \(B_t = (1+r)^t\) for interest rate \(r \geq 0\).

A \textbf{risky asset} with stochastic processes \((S_t^k) = (S_0^k, \dots, S_T^k)\) and \(S_t^k(\omega) > 0\) for \(k = 1, \dots, d\) and \(t = 0, \dots, T\) and all \(\omega \in \Omega\). We define for \(t=0, 1, \dots, T\) \(S_t\) as \[
    S_t \defn (S_t^1, \dots, S^d_t).
\]
For example, imagine these to be \emph{stock prices} -- \(S_t^k\) is the price of stock \(k\) at time \(t\). The processes \((S_t^k)\) are assumed to be adapted \((k=1, \dots, d)\) to the filtration given, i.e.\ \((\cF_t)\). Hence \[
    \cF_t^S \subset \cF_t, \quad\text{where}\quad \cF_t^S = \sigma(S_0, \dots, S_t)
\]
is the \(\sigma\)-algebra generated by \((S_t)\) up to \(t\).

\begin{remark}[Repetition]
    \(\cF_t^X \defn \sigma(\set{X_s \mid s \leq t})\) for all \(t \in I\) is the \(\sigma\)-algebra generated by the stochastic process \(X\) itself.
\end{remark}

We can invest in the assets above and trade them, for this we define a trading strategy.

\begin{definition}[Trading Strategy]
    A trading strategy (a portfolio) is a \(\R^{d+1}\)-valued, \((\cF_t)\)-adapted stochastic process \(\phi = (\phi_0, \dots, \phi_{T-1})\), i.e. \(\phi_t\) is \(\cF_t\)-measurable and \(\phi_t = (\alpha_t, \beta_t)\) for \(t=0, \dots, T-1\).
\end{definition}
\begin{remark}
    In practice:
    \begin{itemize}
        \item \(\beta_t\) is the quantity of the riskless asset that is held in time period \([t, t+1)\) and
        \item \(\alpha_t = (\alpha_t^1, \dots, \alpha_t^d)\) where \(\alpha_t^k\) is the quantity of the risky asset \(k\) that is held in \([t, t+1)\),
        \item we denote \(\beta = (\beta_0, \dots, \beta_{T-1})\) and \(\alpha = (\alpha_0, \dots, \alpha_{T-1})\).
    \end{itemize}
\end{remark}
\begin{remark}[Repetition]
    A real-valued stochastic process is a mapping \(X: I \times \Omega \to \R\) such that \(X(t, \cdot): \Omega \to \R\) is measurable for every \(t \in I\), i.e.\ a sequence of real-valued random variables. For \(\omega \in \Omega\) fixed, \(t \mapsto X_t(\omega)\) is a called a \emph{path} of \(X\).
\end{remark}

\textbf{Adapted trading strategy.} If a trading strategy \(\phi\) is adapted, it means that \(\beta_t = \beta_t(S_0, \dots, S_t)\) and \(\alpha_t^k = \alpha_t^k(S_0, \dots, S_t)\) are functions of the prices \(S_0, \dots, S_t\). Investors thus observe prices up to time \(t\) and choose -- based on this information -- a new composition of \(\phi_t\) of the portfolio at time \(t\) which is then held until \(t+1\).

The information about the price processes is included in the filtration \((\cF_t^S) \subset (\cF_t)\).

We call the value of a trading strategy also a \emph{wealth process}.

\begin{definition}[Wealth process]
    The value of a trading strategy \(\phi\) at times \(t=0, \dots, T-1\) is given by \[
        V_t^\phi = \beta_t B_t + \alpha_t \cdot S_t = \beta_t B_t + \sum_{k=1}^d \alpha_t^k S_t^k.
    \]
    Moreover, we let \(V_T^\phi = \beta_{T-1} B_T + \alpha_{T-1} S_T\).
\end{definition}
\begin{remark}
    \(\beta_t B_t + \alpha_t \cdot S_t\) is the value of the trading strategy immediately after it has been recomposed. Change in the market values due to price changes are then \[
        \beta_{t-1} (B_t - B_{t-1}) + \alpha_{t-1} \cdot (S_t-S_{t-1}).
    \]
\end{remark}

\begin{definition}[Self-financing]
    A trading strategy is called self-financing if for \(t=1, \dots, T-1\)
    \begin{equation}\label{eq:selfFinancing}
        \beta_{t-1} B_t + \alpha_{t-1} \cdot S_t = \beta_t B_t + \alpha_t \cdot S_t.
    \end{equation}
\end{definition}

\begin{remark}[Explanation]
    When the investor observes the new prices \(B_t, S_t\), she adjusts the trading strategy from \(\phi_{t-1}\) to \(\phi_t\) without adding or assuming additional wealth. Thus, \eqref{eq:selfFinancing} must hold.
\end{remark}

\emph{We show:} For a self-financing trading strategy \(\phi = (\alpha, \beta)\), this is equivalent to knowing \((V_0^\phi, \alpha)\) and hence \(\beta\) can be determined from \eqref{eq:selfFinancing}.

Denote the set of trading strategies of risky assets as \[
    \cA \defn \set{\alpha = (\alpha_0, \dots, \alpha_{T-1}) : \alpha_t \text{ is } \cF_t\text{--measurable for } t=0, \dots, T-1}
\]

Hence if the initial wealth \(V_0^\phi\) is known, every \(\alpha \in \cA\) can be complemented in a self-financing way.

\begin{remark}[Notation]
    \(\Delta X_t = X_t - X_{t-1}\), \(\Delta \alpha_t = (\Delta \alpha_t^1, \dots, \Delta \alpha_t^d)\).
\end{remark}

\begin{lemma}\label{le:SELFF_TO_BETA}
    Let \(\phi\) be self-financing. Then we have \[
        \beta_t = \beta_0 - \sum_{k=1}^t \Delta \alpha_n \frac{S_n}{B_n} = V_0^\phi - \sum_{k=0}^t \Delta \alpha_n \frac{S_n}{B_n},
    \]
    for \(t=0, \dots, T-1\) where \(\Delta \alpha_0^k \defn \alpha_0^k\) for \(k=1, \dots, d\).
\end{lemma}
\begin{proof}
    Let \(t=0\), then \(V_0^\phi = \beta_0 B_0 + \alpha_0 \cdot S_0 = \beta_0 + \alpha_0 \cdot S_0\) by normalising \(B_0 = 1\). Hence \[
        \beta_0 = V_0^\phi - \alpha_0 \frac{S_0}{B_0} = V_0^\phi - \Delta \alpha_0 \frac{S_0}{B_0}.
    \]
    Let \(t \in \set{1, \dots, T-1}\), then, since \((\alpha, \beta)\) is self-financing, we get \[
        \beta_t B_t + \alpha_t \cdot S_t = \beta_{t-1} B_t + \alpha_{t-1} \cdot S_t \iff (\beta_t-\beta_{t-1}) B_t = -(\alpha_t - \alpha_{t-1}) \cdot S_t
    \]
    and hence \(\Delta \beta_t = - \Delta \alpha_t \frac{S_t}{B_t}\).
    This implies \[
        \beta_t = \beta_0 + \sum_{n=1}^t \Delta \beta_n = \beta_0 - \sum_{n=1}^t \Delta \alpha_n \frac{S_n}{B_n} = V_0^\phi - \Delta \alpha_0 \frac{S_0}{B_0} - \sum_{n=1}^t \Delta \alpha_n \frac{S_n}{B_n}.\qedhere
    \]
\end{proof}

\begin{definition}[Discounted stock price]
    \(\tilde{S}_t^k \defn \frac{S_t^k}{B_t}\) is the discounted stock price of risky asset \(k\) at \(t\).
\end{definition}

\begin{lemma}\label{le:22}
    Let \(\phi\) be self-financing. Then we have \[
        \frac{V_t^\phi}{B_t} = V_0^\phi + \sum_{n=1}^t \alpha_{n-1} \Delta \tilde{S}_n.
    \]
\end{lemma}
\begin{proof}
    As \(\phi\) is self-financing, we have
    \begin{align*}
        \frac{V_n^\phi}{B_n} - \frac{V_{n-1}^\phi}{B_{n-1}}
        &= \frac{1}{B_n}\left( \beta_n B_n + \alpha_n \cdot S_n \right) - \frac{1}{B_{n-1}}\left( \beta_{n-1} B_{n-1} + \alpha_{n-1} \cdot S_{n-1} \right)\\
        &\stackrel{\text{SF}}{=} \frac{1}{B_n} \left( \beta_{n-1} B_n + \alpha_{n-1} S_n \right) - \frac{1}{B_{n-1}} \left( \beta_{n-1} B_{n-1} + \alpha_{n-1} \cdot S_{n-1} \right)\\
        &= \underbrace{\beta_{n-1}-\beta_{n-1}}_{=0} + \alpha_{n-1} \left( \frac{S_n}{B_n} - \frac{S_{n-1}}{B_{n-1}} \right)\\
        &= \alpha_{n-1} \Delta \tilde{S}_n.
    \end{align*}
    We have that with \(B_0 = 1\): \[
        \frac{V_t^\phi}{B_t} = \frac{V_0^\phi}{B_0} + \sum_{n=1}^t \left( \frac{V_n^\phi}{B_n} - \frac{V_{n-1}^\phi}{B_{n-1}} \right) = V_0^\phi + \sum_{n=1}^t \alpha_{n-1} \Delta \tilde{S}_n.\qedhere
    \]
\end{proof}

\begin{definition}[Gains Process]
    For a trading strategy \(\alpha \in \cA\), the process \((G_t^\alpha)\), defined by \[
        G_0^\alpha = 0 \quad \text{and} \quad G_t^\alpha = \sum_{n=1}^t \alpha_{n-1}  \cdot \Delta \tilde{S}_n, \quad t=1, \dots, T
    \]
    is called the \textbf{gains process}.
\end{definition}

\textbf{No-arbitrage-principle.}

\begin{definition}[Arbitrage Strategy]
    Let \(\phi\) be self-financing. \(\phi\) is called arbitrage strategy if \[
        V_0^\phi = 0, \quad \P(V_T^\phi \geq 0) = 1 \quad \text{and}\quad \P(V_T^\phi > 0) > 0.
    \]
\end{definition}
\begin{remark}
    We say that there is an arbitrage opportunity if such an arbitrage strategy exists. (NA) means that there is no arbitrage opportunity.

    Recall that \(\P(\set{\omega}) > 0\) for any \(\omega \in \Omega\) by definition of our financial market. Thus \[
        \P(V_T^\phi \geq 0) = 1 \iff V_T^\phi(\omega) \geq 0 \quad \text{for any} \quad \omega \in \Omega.
    \]
    Moreover, \[
        \P(V_T^\phi > 0) > 0 \iff \exists \omega \in \Omega: V_T^\phi(\omega) > 0.
    \]
\end{remark}

We know from before that \[
    \frac{V_T^\phi}{B_T} = V_0^\phi + G_T^\alpha, \quad \phi = (\alpha, \beta)
\]
where \(\phi\) is self-financing. Now, an arbitrage strategy exists if and only if there exists a trading strategy \(\phi\) with \(V_0^\phi = 0\) and \(\P(G_T^\alpha \geq 0) = 1\) and \(\P(G_T^\alpha > 0) > 0\).

In words, the next theorem tells us that a financial market is globally free of arbitrage if and only if it is locally free of arbitrage.

\begin{theorem}\label{th:ARB_STRAT_EQUIV}
    The following are equivalent.
    \begin{itemize}
        \item There exists an arbitrage strategy.
        \item There exists a \(t \in \set{1, \dots, T}\) and a \(\cF_{t-1}\)-measurable random vector \(\eta: \Omega \to \R^{d}\) such that \(\P(\eta \cdot (\tilde{S}_t - \tilde{S}_{t-1}) \geq 0) = 1\) and \(\P(\eta \cdot (\tilde{S}_t - \tilde{S}_{t-1}) > 0) > 0\). Here, \(\eta\) depends on \(t\).
    \end{itemize}
\end{theorem}
\begin{proof}
    Let \(\phi = (\alpha, \beta)\) be an arbitrage strategy with wealth process \((V_t^\phi)\) and let \[
        t = \min\set{m \in \N \mid \P(V_m^\phi \geq 0) = 1 \text{ and } \P(V_m^\phi > 0) > 0}.
    \]
    Then \(t \leq T\) and \underline{either} (a) \(\P(V_{t+1}^\phi = 0) = 1\) \underline{or} (b) \(\P(V_{t-1}^\phi < 0) > 0\). In case of (a), we have \[
        \alpha_{t-1} \cdot (\tilde{S}_t - \tilde{S}_{t-1}) = \frac{V_T^\phi}{B_t} - \frac{V_{t-1}^\phi}{B_{t-1}} = \frac{V_t^\phi}{B_t} \geq 0.
    \]
    Using \(\eta = \alpha_{t-1}\) we obtain \(\P(\eta \cdot (\tilde{S}_t - \tilde{S}_{t-1}) > 0) > 0\) for some development of \(S_t\) and moreover \(\P(\eta \cdot (\tilde{S}_n - \tilde{S}_{n-1}) \geq 0) = 1\). In case (b) we get by \[
        \eta = \alpha_{t-1} \indic[V_{t-1}^\phi < 0]
    \]
    that \[
        \eta \cdot (\tilde{S}_t - \tilde{S}_{t-1}) = \left(\frac{V_t^\phi}{B_t} - \frac{V_{t-1}^\phi}{B_{t-1}}\right) \cdot \indic[V_{t-1}^\phi < 0] \geq \frac{V_t^\phi}{B_t} \indic[V_{t-1}^\phi < 0]
    \]
    and hence \(\P(\eta \cdot (\tilde{S}_t - \tilde{S}_{t-1}) \geq 0) = 1\) and \(\P(\eta \cdot (\tilde{S}_t - \tilde{S}_{t-1}) > 0) > 0\).

    Now the backward direction. Define a trading strategy \(\phi = (\alpha, \beta)\) by \[
        \alpha_m = \begin{cases}
            \eta, &m=t-1\\
            0, &\text{else}.
        \end{cases}
    \]
    \(\alpha\) can be completed to a self-financing trading strategy  with \(V_0^\phi = 0\). By the previous lemmas, \[
        \frac{V_T^\phi}{B_T} = V_0^\phi + \sum_{n=1}^t \alpha_{n-1}\Delta \tilde{S}_n = \eta \cdot (\tilde{S}_n - \tilde{S}_{n-1}).
    \]
    Moreover, using the assertion we get \(\P(\eta \cdot (\tilde{S}_t - \tilde{S}_{t-1}) \geq 0) = 1 = \P(V_T^\phi/B_T \geq 0)\) and \(\P(\eta \cdot (\tilde{S}_t - \tilde{S}_{t-1}) > 0) = \P(V_T^\phi/B_T > 0) > 0\).
\end{proof}

\begin{example}
    We assume a financial market with \(T=2\) periods and a RA with \(B_0 = B_1 = B_2 = 1\). We assume the following price behaviour.
    \begin{figure}[h!]
        \begin{center}
            \begin{forest}
                for tree={
                    grow=east,
                    draw,
                    edge={-latex},
                    anchor=west,
                    s sep=20pt,
                    l sep=30pt,
                    align=center,
                    font=\small,
                }
                [{$S_0 = 4$}
                    [{$S_1(u_1)=6$}
                        [{$S_2(u_1,u_2)=8$}]
                        [{$S_2(u_1,d_2)=5$}]
                    ]
                    [{$S_1(d_1)=3$}
                        [{$S_2(d_1,u_2)=4$}]
                        [{$S_2(d_1,d_2)=2$}]
                    ]
                ]
            \end{forest}
        \end{center}
        \caption{Price behaviour in our \(2\)-period market.}
        \label{fig:example_2_period_market_dt}
    \end{figure}\\
    We let \(\Omega = \set{u_1, d_1} \times \set{u_2, d_2}\). We now want to check whether our whole financial market is free of arbitrage by using the previous theorem. We start with \(t=1\) and obtain \[
        \eta\left( \tS_n(y_1) - S_0 \right) = \begin{cases}
            \eta(6-4)=2\eta, &y_1=u_1\\ \eta(3-4)=-\eta, &y_1=d_1.
        \end{cases}
    \]
    As the cases have different signs, we cannot choose any common \(\eta \neq 0\) such that \(\eta(\tS_1(y_1)-S_0) \geq 0\) for all \(y_1\) and hence (NA) holds in period \(t=1\). For \(t=2\), need to check two cases. Indeed, \[
        \eta(u_1) \left(\tS_2(u_1, y_2)-\tS_1(u_1)\right) = \begin{cases}
            \eta(u_1) (8-6) = 2 \eta(u_1), &y_2=u_2\\
            \eta(u_1)(5-6)=-\eta(u_1), &y_2=d_2.
        \end{cases}
    \]
    By the same logic as before, with differing signs, we have (NA). Moreover,
    \[
        \eta(d_1)\left(\tS_1(d_1,y_2)-\tS_1(d_1)\right) = \begin{cases}
            \eta(d_1)(4-3)=\eta(d_1),&y_2=u_2\\ \eta(d_1)(2-3)=-\eta(d_1),&y_2=d_2
        \end{cases}
    \]
    yields differing signs again. Now we have checked all branches of the decision tree and get that (NA) holds for the whole financial market by \Cref{th:ARB_STRAT_EQUIV}.
\end{example}

\subsection{Options}

Options are characterised by the payoff. For \emph{european options}, the payoff happens at exercise date \(T\).

\begin{definition}[Contingent Claim]
    A contingent claim is an \(\cF_T\)-measurable random variable \(H\) with values in \(\R\).
\end{definition}
\begin{remark}
    If \(H \in \cF_T^S\), then \(H = h(S_0, \dots, S_T)\).
\end{remark}

\begin{example}[Examples of Contingent Claims]
    \textbf{European call options} with strike price \(K\): \[
        H = (S_T-K)^+
    \]
    is only exercised when \(S_T > K\).
    \textbf{European put options} with strike \(K\): \[
        H = (K-S_T)^+
    \]
    is only exercised when \(S_T < K\). A \textbf{Future} is delivered with certainty, thus \[
        H = S_T-K.
    \]
    Here, \(K\) is a fixed reference price and \(T\) the delivery date.
    A \textbf{digital call option} with strike \(K\):
    \[
        H = \indic[S_T>K]
    \]
    yields payoff of \(1\) unit if \(S_T>K\). A \textbf{down-and-out-call} with strike \(K\) and barrier \(B\):\[
        H = (S_T-K)^+ \indic[\min_{t \in \set{0, \dots, T}} S_t > B]
    \]
    depends on the whole path of \(S\). These are cheaper than classical options. \textbf{Asian call options} are characterised by \[
        H = \left( S_T-\frac{1}{T}\sum_{t=1}^T S_t \right)^+
    \]
    is only exercised when the stock price is greater than the arithmetic mean. Also these are obviously path-dependent.
\end{example}

\begin{definition}[Attainability and completeness]
    \begin{enumerate}[label=(\alph*)]
        \item A contingent claim \(H\) is attainable if there is a trading strategy \(\phi\) with \(V_T^\phi = H\). Then \(\pi(H) = V_0^\phi\) is called a price of \(H\) and \(\phi\) is called duplication/replication/hedging strategy of \(H\).
        \item We say a market is complete if any contingent claim is attainable.
    \end{enumerate}
\end{definition}

With this definition we get the following lemma.

\begin{lemma}[Price of attainable claims]\label{lem:priceOfAttainableClaims}
    Suppose absence of arbitrage (NA). Then, the price \(\pi(H)\) for an attainable contingent claim \(H\) is unique and thus independent of the choice of hedging strategy.
\end{lemma}
\begin{proof}
    Let \(H\) be an attainable contingent claim. Let \(\phi = (\alpha, \beta)\) and \(\tilde{\phi} = (\tilde{\alpha}, \tilde{\beta})\) be hedging strategies for \(H\). By \Cref{le:SELFF_TO_BETA}, \(\phi, \tilde{\phi}\) can be expressed via \((V_0^\phi, \alpha), (V_0^{\tilde{\phi}}, \tilde{\alpha})\) and by lemma 2.2, \[
        V_0^\phi + G_T^\alpha = \frac{H}{B_T} = V_0^{\tilde{\phi}} + G_T^{\tilde{\alpha}}
    \]
    and \(H = V_T^\phi = V_T^{\tilde{\phi}}\) as \(\phi\) and \(\tilde{\phi}\) are hedging strategies. Assume \(d = V_0^{\tilde{\phi}} - V_0^\phi > 0\). Then
    \begin{align*}
        0
        &= V_0^\phi - V_0^{\tilde{\phi}} - G_T^{\tilde{\alpha}} + G_T^\alpha\\
        &= -d - G_T^{\tilde{\alpha}} + G_T^{\alpha}\\
        &= -d + \sum_{n=1}^T \left( \alpha_{n-1} - \tilde{\alpha}_{n-1} \right) \cdot \Delta \tilde{S}_{n}\\
        &= -d + G_T^{\alpha-\tilde \alpha} \implies G_T^{\alpha - \tilde \alpha} = d > 0.
    \end{align*}
    Now, \(\psi\) is an arbitrage strategy, where \(\psi \defn (\hat{\alpha}, \hat{\beta})\) where \(\hat{\alpha} \defn \alpha - \tilde{\alpha}\) and \(\hat{\beta}\) is determined by \Cref{le:SELFF_TO_BETA} with \(V_0^\phi = 0\). This is a contradiction to (NA).
\end{proof}

\begin{example}
    We use the tree-based model from the last example. Recall the structure:
    \begin{figure}[h!]
        \begin{center}
            \begin{forest}
                for tree={
                    grow=east,
                    draw,
                    edge={-latex},
                    anchor=west,
                    s sep=20pt,
                    l sep=30pt,
                    align=center,
                    font=\small,
                }
                [{$S_0 = 4$}
                    [{$S_1(u_1)=6$}
                        [{$S_2(u_1,u_2)=8$}]
                        [{$S_2(u_1,d_2)=5$}]
                    ]
                    [{$S_1(d_1)=3$}
                        [{$S_2(d_1,u_2)=4$}]
                        [{$S_2(d_1,d_2)=2$}]
                    ]
                ]
            \end{forest}
        \end{center}
        \caption{Price behaviour in our \(2\)-period market.}
    \end{figure}
    Consider the digital call with \(H = \indic[S_2 \geq 5]\). This will only pay \(1\) if \(S_2 \geq 5\). We get 
    \begin{align*}
        H(u_1, u_2) &= H(u_1, d_2) = 1\\
        H(d_1, u_2) &= H(d_1, d_2) = 0.
    \end{align*}
    How can we construct a hedging strategy here? We must find \(\phi\) with \(V_T^\phi = H\). For \(t=2\) and the upper node, we get \begin{align*}
        H(u_1,u_2)&=1=8\alpha_1(u_1)+\beta_1(u_1)=V_2^\phi(u_1,u_2)\\
        H(u_1,d_2)&=1=5\alpha_1(u_1)+\beta_1(u_1)=V_2^\phi(u_1,d_2).
    \end{align*}
    Solving yields \(alpha_1(u_1)=0\) and \(\beta_1(u_1)=1\). Hence \(V_1^\phi = 6\alpha_1(u_1)+\beta_1(u_1)=1\) by the self-financing property. For the lower node, observe
    \begin{align*}
        H(d_1, u_2) &= 0 = 4 \alpha_1(d_1)+\beta_1(d_1)=V_2^\phi(d_1,u_2)\\
        H(d_1, d_2) &= 0 = 2 \alpha_1(d_1)+\beta_1(d_1)=V_2^\phi(d_1,d_2).
    \end{align*}
    Solving yields \(\alpha_1(d_1)=0\) and \(\beta_1(d_1)=0\) and hence \(V_1^\phi = 3 \alpha_1(d_1)+\beta_1(d_1) = 0\) by self-financing.

    We can now look at \(t=1\). We have
    \begin{align*}
        V_1^\phi(u_1) &= 1 = 6\alpha_0+\beta_0\\
        V_1^\phi(d_1) &= 0 = 3\alpha_0+\beta_0,
    \end{align*}
    which yields \(\alpha_0=1/3\) and \(\beta_0=-1\) and hence \[
        \pi(H) = V_0^\phi = S_0\alpha_0 + \beta_0B_0 = 4 \alpha_0+\beta_0 = \frac{4}{3}-1=\frac{1}{3}.
    \]
\end{example}

\begin{remark}
    All considerations in this section are without accounting for transaction costs.
\end{remark}

\newpage
\section{The Cox--Ross--Rubinstein model}

This is a simple model in discrete time. We assume \(1\) riskless asset and \(1\) risky asset.

\subsection{One-period CRR model}

We assume \(T=1\) and \(\Omega=\set{u, d}\) and \(\cF_T = \cF = 2^\Omega\). For the riskless asset, we set \(B_0=1\) and \(B_1 = 1+r,\, r \geq 0\). For the risky asset, we assume a random variable \(S_0 > 0\) and \[
    S_1(\omega) = \begin{cases}
        uS_0, &\omega=u\\
        dS_0, &\omega=d
    \end{cases}
\]
for functions \(0 < d < u\). We then call \(u\) \emph{up-factor} and \(d\) the \emph{down-factor}. The case \(u=d\) is not interesting since it reduces to a deterministic case.

The basic question we want to ask is: \emph{When is this model free of arbitrage?}

\begin{theorem}\label{th:CRR_NA}
    Consider the one-period CRR model. Then, the market is free of arbitrage if and only if \(d < 1 + r < u\).
\end{theorem}
\begin{proof}
    Let's assume \(d < 1+r < u\) or equivalently \(\frac{dS_0}{1+r} - S_0 < 0 < \frac{u S_0}{1+r} - S_0\). Hence, \(S_1(d)/(1+r)-S_0 < 0 < S_1(u)/(1+r)-S_0\). Now, \(\tilde{S} = S/B\) with \(B_1 = 1+r\). We get \(\tilde{S}_1(d) - S_0 < 0 < \tilde{S}_1(u) - S_0\) and by noting \(\tilde{S_0} = S_0\) and applying \Cref{th:ARB_STRAT_EQUIV}, we get that there exists an \(\omega\) and some \(\eta \neq 0\) such that \(\eta(\tilde{S_n}(\omega) - \tilde{S}_0) < 0\), which implies that there is no arbitrage.
\end{proof}

What can we say about completeness?

\begin{theorem}\label{th:CRR_COMPLETE}
    Suppose there is no arbitrage. Then the CRR model is complete. In particular, \[
        \alpha_0 = \frac{H(u) - H(d)}{(u-d)S_0}, \quad \beta_0 = \frac{uH(d) - dH(u)}{(u-d)(1+r)}.
    \]
    Then, \(\pi(H) = \frac{uH(d) - dH(u)}{(u-d)(1+r)} + \frac{H(u)-H(d)}{u-d}\) is the unique price.
\end{theorem}
\begin{proof}
    If \(\phi\) is a hedging strategy, then at \(T=1\), we have \[
        V_1^\phi = \beta_0(1+r) + \alpha_0 S_1 = H.
    \]
    Hence, \begin{align*}
        \beta_0(1+r) + \alpha_0 \underbrace{S_1(u)}_{uS_0} &= H(u)\\
        \beta_0 (1+r) + \alpha_0 \underbrace{S_1(d)}_{dS_0} &= H(d).
    \end{align*}
    Some calculating yields \(\alpha_0=\frac{H(u)-H(d)}{(u-d)S_0}\) and \(\beta_0=\frac{uH(d)-dH(u)}{(u-d)(1+r)}\). Obviously, \(\pi(H)=V_0^\phi=\beta_0B_0+\alpha_0S_0\).
\end{proof}

\begin{example}
    Let \(u=1.1\) and \(d=0.9\) and \(r=0.05\). Due to \Cref{th:CRR_NA}, the market is free of arbitrage. Let \(S_0 = 100\) and \(H(u)=80\) and \(H(d)=60\). The price due to \Cref{th:CRR_COMPLETE} is \[
        \pi(H) = \frac{1.1 \cdot 60 - 0.9 \cdot 80}{(1.1 - 0.9) 1.05} + \frac{80-60}{1.1-0.9} = 71.42.
    \]
    The corresponding hedging strategy is \[
        \alpha_0 = \frac{80-60}{0.2 \cdot 100} = 1
    \]
    and \[
        \beta_0 = -28.57.
    \]
\end{example}

\begin{remark}[Preparatory remark on Equivalent Martingale Measures (EMMs)]
    We can rearrange \(\pi(H)\) from before as \[
        \pi(H) = \frac{H(u)}{1+r} \cdot \frac{1+r-d}{u-d} + \frac{H(d)}{1+r} \left(1-\frac{1+r-d}{u-d}\right) =: \star.
    \]
    This can be seen from \begin{align*}
        \star
        &= \frac{H(u)}{1+r}\left(\frac{1+r}{u-d}-\frac{d}{u-d}\right) + \frac{H(d)}{1+r}\left(1-\frac{1+r}{u-d}+\frac{d}{u-d}\right)\\
        &= \frac{H(u)}{u-d} - \frac{dH(u)}{(1+r)(u-d)} + \frac{H(d)}{1+r} - \frac{H(d)}{u-d} + \frac{d H(d)}{(1+r)(u-d)}\\
        &= \frac{H(u)-H(d)}{u-d} + \frac{dH(d)-dH(u)}{(1+r)(u-d)}+\frac{H(d)}{1+r}\\
        &= \frac{H(u)-H(d)}{u-d} + \frac{dH(d)-dH(u)+uH(d)-dH(d)}{(1+r)(u-d)}\\
        &= \frac{H(u)-H(d)}{u-d} + \frac{uH(d)-dH(u)}{(1+r)(u-d)} = \pi(H).
    \end{align*}
    We fix \(q \defn \frac{1+r-d}{u-d}\) and hence \(0 < q < 1\) as by (NA) we know that \(d<1+r<u\) and thus \[
        \pi(H) = \frac{H(u)}{1+r}q+\frac{H(d)}{1+r}(1-q).
    \]
    Define the probability measure \(\Q\) on \((\Omega, \cF_T)\) as \[
        \Q(\set{u}) = q, \quad \Q(\set{d})=1-q.
    \]
    Hence, \(\pi(H) = \E_\Q \left[ \frac{H}{1+r} \right]\) where \(\E_\Q\) is the expectation w.r.t.\ \(\Q\).
    We obtain for the discounted price \(\tilde{S}_1 = \frac{S_1}{B_1}\) that
    \begin{align*}
        \E_\Q \tilde{S}_1
        &= S_0 \left( \frac{u}{1+r}q + \frac{d}{1+r}(1-q) \right)\\
        &= S_0 \left( q \left[ \frac{u}{1+r}-\frac{d}{1+r} \right] + \frac{d}{1+r} \right)\\
        &= S_0 \left( \frac{1+r-d}{u-d} \frac{u-d}{1+r} + \frac{d}{1+r} \right)\\
        &= S_0 \left( \frac{1+r-d+d}{1+r} \right) = \tilde{S}_0.
    \end{align*}
    Hence, discounted stock prices are martingales with respect to the risk-neutral measure. One can even show that the measure \(\Q\) is the only (i.e.\ unique) measure that satisfies the martingale property \(\E_\Q \tilde{S}_1 = \tilde{S}_0\).
\end{remark}

\subsubsection{Digression: Conditional Expectation and Martingales}
We shortly recap some things on conditional expectation and martingales now.
\begin{definition}[Conditional Expectation]
    Let \(X \in L^1(\Omega, \cF, \P)\) and \(\cG \subset \cF\) be a sub-\(\sigma\)-algebra. \(Z\) is the conditional expectation of \(X\) conditioned on \(\cG\) if and only if \begin{itemize}
        \item \(Z\) is \((\cG, \cB)\)-measurable,
        \item \(\intt[A][][X][\P] = \intt[A][][Z][\P]\) for all \(A \in \cG\).
    \end{itemize}
    The conditional expectation of \(X\) given \(B \in \cF\) with \(\P(B) > 0\) is \[
        \E(X \mid B) = \frac{\E(X \cdot \indic_B)}{\P(B)} = \frac{1}{\P(B)} \intt[B][][X][\P].
    \]
\end{definition}

\begin{remark}
    Recall that \(\P(A \mid B) = \frac{\P(A \cap B)}{\P(B)},\, A, B \in \cF, \P(B) > 0\).
\end{remark}
Let \(\Omega\) be finite and \(\P(\set{\omega}) > 0\) for any \(\omega \in \Omega\). A sub-\(\sigma\)-algebra \(\cG\) of \(\cF\) can always be generated by a partition of \(\Omega\). That means there exist subsets \(A_1, \dots, A_n\) with \(A_i \cap A_j = \emptyset\) for any \(i, j \in \set{1, \dots, n}\) and \(\bigcup_{1 \leq i \leq n} A_i = \Omega\) and hence \[
    \cG = \sigma\left(\set{A_1, \dots, A_n}\right) = \set{\bigcup_{i \in T} A_i: T \subset \set{1, \dots, n}}.
\]
\begin{theorem}
    Let \(\Omega\) be finite and \(\cG = \sigma(\set{A_1, \dots, A_n})\) be a sub-\(\sigma\)-algebra of \(\cF\). The conditional expectation of \(X\) given \(\cG\) is the random variable \[
        \E(X \mid \cG)(\omega) = \sum_{i=1}^n \E(X \mid A_i) \cdot \indic_{A_i}(\omega), \quad \omega \in \Omega.
    \]
\end{theorem}
\begin{proof}
    Let \(Z\) be defined as above. Then \(Z\) is constant on the respective sets \(A_i\) and hence \(Z \in (\cG, \cB)\). For all \(j \in \set{1, \dots, n}\), we have for the expectation
    \[
        \E(Z \mid A_j) = \intt[A_j][][Z][\P]
        = \intt[A_j][][\E(X \mid A_j)][\P]
        = \intt[A_j][][\frac{\E(X \cdot \indic_{A_j})}{\P(A_j)}][\P] = \E(X \indic_{A_j}).\qedhere
    \]
\end{proof}

\begin{lemma}[Some properties]
    Let \(X, Y \in L^1(\Omega, \cF, \P)\). Then
    \begin{itemize}
        \item \(\E(\E(X \mid \cG)) = \E(X)\),
        \item if \(X \in \cG\), then \(\E(X \mid \cG) = X\),
        \item \(\E(aX+bY \mid \cG) = a \E(X \mid \cG) + b \E(Y \mid \cG)\) for any \(a, b \in \R\),
        \item \(X \leq Y \implies \E(X \mid \cG) \leq \E(Y \mid \cG)\),
        \item conditional Jensen's inequality: \(f: \R \to \R\) integrable and convex, then \[
            \E(f(X) \mid \cG) \geq f(\E(X \mid \cG)),
        \]
        \item Tower property: if \(\cH \subseteq \cG\), then \[
            \E(\E(X \mid \cG) \mid \cH) = \E(\E(X \mid \cH) \mid \cG) = \E(X \mid \cH),
        \]
        \item measurable factorisation: for \(Y \in \cG\) we have \[
            \E (\abs[YX]) < \infty \implies \E(YX \mid \cG) = Y \E(X \mid \cG),
        \]
        \item \(X \perp \cG\) implies \(\E(X \mid \cG) = \E(X)\).
    \end{itemize}
\end{lemma}

A martingale is a stochastic process with special properties.

\begin{definition}[Stochastic Process]
    A sequence of random variables \(\left(X_t\right)_{t \in \N_0}\) with \(X_t: \Omega \to \R\) is called a stochastic process. A sequence \(\left(\cF_t\right)_{t \in \N_0}\) of sub-\(\sigma\)-algebras with \(\cF_t \subset \cF\) is called a filtration if for all \(s \leq t: \cF_s \subseteq \cF_t\) for any \(s, t \in \N_0\). A stochastic process is adapted w.r.t.\ the filtration if \(X_t\) is measurable w.r.t.\ \(\cF_t\) for every \(t \in \N_0\).
\end{definition}

With this we can define what a martingale is.

\begin{definition}[Martingale]
    Let \(\left(X_t\right)_{t \in \N_0}\) be an adapted stochastic process such that \(\E(\abs[X_t]) < \infty\) for any \(t \in \N_0\). The process is called martingale if and only if
    \begin{equation}\label{eq:martingale}
        \E(X_t \mid \cF_s) = X_s,\qquad s \leq t.
    \end{equation}
\end{definition}
\begin{remark}[Interpretation]
    The value of the process remains \underline{constant in expectation} at all times. This can be used to model a fair game.
    A \textbf{submartingale} is a stochastic process for which the expectation increases: \(\E(X_t \mid \cF_s) \geq X_s\)
    and a \textbf{supermartingale} has decreasing expectation: \(\E(X_t \mid \cF_s) \leq X_s\) for any \(s \leq t \in \N_0\).
\end{remark}

\begin{remark}[Equivalent characterisations]
    We see that for \(t \in \N_0\)
    \begin{itemize}
        \item \eqref{eq:martingale} \(\iff \E(X_{t+1} \mid \cF_t) = X_t\),
        \item \eqref{eq:martingale} \(\iff \E(X_{t+1} - X_t \mid \cF_t) = 0\),
        \item \(X \in \cF \implies X_t = \E(X \mid \cF_t)\) is \(\cF_t\)-martingale.
    \end{itemize}
\end{remark}

\begin{example}
    Let \(X_1, \dots\) be independent and integrable with \(0\) mean. Define \(S_0 = 0\) and \(S_n = \sum_{i=1}^n X_i\) and let \(\cF_t = \sigma(\set{X_1, \dots, X_n})\) with \(\cF_0 = \set{\Omega, \emptyset}\). We check that
    \begin{align*}
        \E (S_{t+1} \mid \cF_t)
        &= \E(S_t+X_{t+1} \mid \cF_t)\\
        &= \E(S_t \mid \cF_t) + \E(X_{t+1} \mid \cF_t)\\
        &= S_t + \E(X_{t+1} \mid \cF_t)\\
        &= S_t + \E (X_{t+1}) = S_t
    \end{align*}
    since \(X_{t+1} \perp \cF_t\).
\end{example}

\begin{lemma}
    Let \((X_t)_{t \in \N_0}\) be an \((\cF_t)_{t \in \N_0}\)-martingale and \(f: \R \to \R\) convex with \(\E(\abs[f(X)]) < \infty\) for any \(t \in \N_0\). Then \((f(X_t))_{t \in \N_0}\) is a submartingale.
\end{lemma}
\begin{proof} \(\E(f(X_t) \mid \cF_s) \geq f(\E(X_t \mid \cF_s)) = f(X_s)\).
\end{proof}

\begin{definition}[Previsibility]
    A stochastic process is called \emph{previsible} if \(X_t \in \cF_{t-1}\) for any \(t > 1\).
\end{definition}

\begin{theorem}[Doob decomposition]
    Let \((X_t)\) be a \((\cF_t)\)-supermartingale. Then \((X_t)\) can be written as \[
        X_t = M_t + A_t, \quad t \in \N_0
    \]
    where \(M_t\) is a \(\cF_t\)-martingale, \(A_t\) is decreasing and \(A_0=0\). Moreover, \((A_t)\) is previsible and the decomposition is unique \(\P\)-a.s.
\end{theorem}

\begin{remark}
    Recall the gains process \[
        G_t^\alpha = \sum_{n=1}^t \alpha_{n-1} \cdot \Delta \tilde{S}_n = \sum_{n=1}^t \alpha_{n-1} \cdot (\tilde{S_n}-\tilde{S}_{n-1})
    \]
    for \(t \in \set{1, \dots, T}\). Consider a gambling game in discrete time. We play at time \(t \in \N\) and \(\Delta Z_t = T_t - Z_{t-1}\) denotes the profit in time \(t\). If \((Z_t)\) is a martingale, the game is fair because \[
        \E(\Delta Z_t \mid \cF_{t-1}) = \E(Z_t - Z_{t-1} \mid \cF_{t-1}) = 0.
    \]
    If \((Z_t)\) is a supermartingale, i.e.\ \(\E(\Delta Z_t \mid \cF_{t-1}) \leq 0\) means the game is disadvantageous and \((Z_t)\) being a submartingale means that the game is advantageous.
\end{remark}

\textbf{Question.} Can we obtain a positive expected profit?
Let \((c_t)\) be \((\cF_t)\)-adapted and let \(c_{t-1}\) represent the stake in the \(t\)-th game. The player chooses \(c_{t-1}\) using the information available up to time \(t-1\). The profit of the \(t\)-th game is \[
    c_{t-1} \Delta Z_t = c_{t-1} (Z_t-Z_{t-1})
\]
and hence the total profit \[
    G_t = \sum_{n=1}^t c_{n-1} \Delta Z_n , \quad G_0=0.
\]
\((G_t)\) is then called \textbf{martingale transformation} of \((Z_t)\).

\begin{theorem}
    Let \((Z_t)\) and \((c_t)\) be \((\cF_t)\)-adapted stochastic processes such that\[
        G_t = \sum_{n=1}^t c_{n-1} \Delta Z_n, \quad G_0=0, t \in \N
    \]
    is integrable. Let \((Z_t)\) be a martingale. Then \((G_t)\) is also a martingale.
\end{theorem}
\begin{proof}
    By assumption, \((G_t)\) is integrable. \((G_t)\) is adapted since \((Z_t)\) and \((c_t)\) are adapted. The martingale property is verified by \[
        \E(G_t-G_{t-1} \mid \cF_{t-1}) = \E(c_{t-1}(Z_t-Z_{t-1}) \mid \cF_{t-1}) = c_{t-1} \E(Z_t-Z_{t-1}\mid \cF_{t-1}) = 0.\qedhere
    \]
\end{proof}

\subsection{Multi-period CRR model}

We are looking at a \(T\)-period CRR model with \(T \in \N\) and trading times \(t=0, \dots, T-1\). Let \(r \geq 0\) and let the riskless asset assume dynamics \[
    B_{t+1} = (1+r) B_t = (1+r)^{t+1},\quad B_0=1, t = 1, \dots, T-1.
\]
The construction of the price process of the risky asset on the product space \((\Omega, \cF)\) is such that \(\Omega = \set{d,u}^T\) and \(\cF = 2^\Omega\) with any \(\omega\) as \[
    \omega = (y_1, \dots, y_T) \in \Omega \text{ with } y_t \in \set{d, u}, t = 1, \dots, T
\]
Again, \(\P\) is a probability measure on \((\Omega, \cF)\) such that \(\P(\set{\omega}) > 0\) for all \(\omega \in \Omega\).
For the moment, no further specification of \(\P\) is needed. We now define \(Y_t\) on \((\Omega, \cF, \P)\) in the form of \[
    Y_t(\omega) = Y_t(y_1, \dots, y_T) = y_t, \quad t=1, \dots, T.
\]
The price process \(S=(S_t)\) is the \(T\)-period CRR model \[
    S_t = S_0 \prod_{n=1}^t Y_n, \quad t=1, \dots, T.
\]
The information flow is modelled by the filtration \[
    \cF_0 = \set{\emptyset, \Omega}, \quad \cF_t = \sigma(Y_1, \dots, Y_t) = \sigma(S_0, \dots, S_t) = \cF_t^S, \quad t=1, \dots, T.
\]

\begin{figure}[h!]
    \begin{center}
        \begin{tikzpicture}[
            ->, >=stealth, % Set arrow style
            node distance=2.5cm, % Distance between nodes
            every node/.style={font=\small}, % Font size for text in nodes
            state/.style={rectangle, draw, minimum size=6mm} % Style for boxed nodes
        ]

        % --- Define Variables for Shifts ---
        % Horizontal shift (time step)
        \def\xdist{1.5cm}
        % Vertical shift (up/down movement)
        \def\ydist{1cm}

        % Define Nodes
        \node[state] (S0) {$S_0$};

        \node[state, right of=S0, xshift=\xdist, yshift=\ydist] (S1u) {$S_1=uS_0$};
        \node[state, right of=S0, xshift=\xdist, yshift=-\ydist] (S1d) {$S_1=dS_0$};

        \node[state, right of=S1u, xshift=\xdist, yshift=\ydist] (S2uu) {$S_2=u^2S_0$};
        \node[state, right of=S1u, xshift=\xdist, yshift=-\ydist] (S2ud) {$S_2=udS_0$};

        \node[state, right of=S1d, xshift=\xdist, yshift=-\ydist] (S2dd) {$S_2=d^2S_0$};

        \node[state, right of=S2uu, xshift=\xdist, yshift=\ydist] (S3uuu) {\(S_3=u^3S_0\)};
        \node[state, right of=S2uu, xshift=\xdist, yshift=-\ydist] (S3uud) {\(S_3=du^2S_0\)};
        \node[state, right of=S2dd, xshift=\xdist, yshift=\ydist] (S3ddu) {\(S_3=d^2uS_0\)};
        \node[state, right of=S2dd, xshift=\xdist, yshift=-\ydist] (S3ddd) {\(S_3=d^3S_0\)};

        % Draw Arrows/Edges
        % S0 to S1
        \draw (S0) -- (S1u);
        \draw (S0) -- (S1d);

        % S1u to S2
        \draw (S1u) -- (S2uu);
        \draw (S1u) -- (S2ud);

        % S1d to S2
        \draw (S1d) -- (S2ud);
        \draw (S1d) -- (S2dd);

        % S2uu to S3
        \draw (S2uu) -- (S3uuu);
        \draw (S2uu) -- (S3uud);
        \draw (S2ud) -- (S3uud);
        \draw (S2ud) -- (S3ddu);
        \draw (S2dd) -- (S3ddu);
        \draw (S2dd) -- (S3ddd);
        \end{tikzpicture}
    \end{center}
    \caption{Price behaviour in our \(3\)-period market.}
    \label{fig:example_3_period_market_crr}
\end{figure}

\begin{remark}
    Recombining trees, as in \Cref{fig:example_3_period_market_crr} are the only trees that are feasible in practice due to exploding complexity otherwise. They are characterised by \(ud=du\).
\end{remark}

\textbf{Questions}. How about absence of arbitrage? The same conditions as in the \(1\)-period CRR model must hold!

\begin{theorem}
    In the \(T\)-period CRR model, the market is free of arbitrage if and only if \(d < 1+r < u\).
\end{theorem}
\begin{proof}
    We use once more \Cref{th:ARB_STRAT_EQUIV}.
    Let \(\eta\) be \(\cF_{t-1}\)-measurable and observe \[
        \eta\left(\frac{S_t}{B_t}-\frac{S_{t-1}}{B_{t-1}}\right) = \eta\left( \frac{Y_tS_{t-1}}{(1+r)B_{t-1}}-\frac{S_{t-1}}{B_{t-1}} \right).
    \]
    Hence \[
        \eta(S_t-\tilde{S}_{t-1}) \geq 0 \implies \eta\left(\frac{Y_t}{1+r}-1\right) \geq 0.
    \]
    \(\eta\) is \(\cF_{t-1}\)-measurable and hence independent of \(Y_t\). Moreover, \(u/(1+r)-1\) and \(d/(1+r)-1\) have different signs if and only if \(d < 1+r < u\).
\end{proof}

\color{red}
Missed the first few minutes here.
\color{black}

\(Y_1, \dots, Y_T\) are i.i.d. random variables with \(\Q(Y_t = u) = q = 1 - \Q(Y_t=d)\) by construction. Again, \(\Q\) is the only measure w.r.t. which \((\tilde{S}_t)\) is a martingale (see Theorem 4.1).

What about the price of a contingent claim? \(H\) in the multi-period CRR model.

\begin{theorem}[should be 3.4]\label{thm:34}
    Suppose (NA). Then the \(T\)-period CRR is complete. In particular, for every contingent claim \(H\), there exists a unique self-financing trading strategy \(\phi=(\alpha, \beta)\) such that \(V_T^\phi=H\). The price of \(H\) is then given by \[
        \pi(H) = \beta_0B_0+\alpha_0S_0 = \sum_{\omega = (y_1, \dots, y_T) \in \Omega} q_{y_1} \cdot \cdots \cdot q_{y_T} \frac{H(\omega)}{B_T} = \E_\Q \frac{H}{B_T}.
    \]
\end{theorem}
\begin{proof}
    Let \(H\) be an arbitrary contingent claim. \(\pi(H)\) and \(\phi\) are obtained recursively from the binomial tree. As \(\phi = (\alpha, \beta)\) is self-financing, we have for \(t=1,\dots,T\) that \begin{equation}\label{eq:tmpForProof341}
        V_t^\phi = \beta_{t-1}B_t + \alpha_{t-1} S_t
    \end{equation}
    and \begin{equation}\label{eq:tmpForProof342}
        V_{t-1}^\phi = \beta_{t-1} B_{t-1} + \alpha_{t-1} S_{t-1}.
    \end{equation}
    We start backwards in \(t=T\). Fix \(V_T=H\) and \((y_1, \dots, Y_{T-1})\). As \(Y_T\) can attain two values (\(u, d\)), \eqref{eq:tmpForProof341} becomes a linear system of equations with two equations and two unknowns \(B_{T-1}, \alpha_{T-1}\). Now, \(\beta_{T-1}(\omega)\) and \(\alpha_{T-1}(\omega)\) depend only on \(y_1, \dots, y_{T-1}\) as they are \(\cF_{T-1}\)-measurable (see definition 2.1 of trading strategies). Let \(h_{T-1}=(y_1, \dots, y_{T-1})\). Then \[
        V_T^\phi(h_{T-1}, u) = H(h_{T-1}, u) = \beta_{T-1}(h_{T-1})B_T + \alpha_{T-1}S_{T-1}(h_{T-1})u
    \]
    and \[
        V_T^\phi(h_{T-1}, d) = H(h_{T-1}, d) = \beta_{T-1}(h_{T-1})B_T + \alpha_{T-1}(h_{T-1})S_{T-1}(h_{T-1})d.
    \]
    This system is uniquely solvable for \((\alpha_{T-1}, \beta_{T-1})\) in dependence of \(h_{T-1}=(y_1,\dots,y_{T-1})\). We get \[
        \alpha_{T-1}= \frac{H(h_{T-1},u)-H(h_{T-1},d)}{(u-d)S_{T-1}(h_{T-1})}
    \]
    and \[
        \beta_{T-1}(h_{T-1})=\frac{uH(h_{T-1},u)-dH(h_{T-1},d)}{(u-d)B_T}.
    \]
    Using \Cref{th:CRR_COMPLETE} and substituting \(\alpha_{T-1}, \beta_{T-1}\) yields
    \begin{align*}
        V_{T-1}^\phi(h_{T-1})
        &=\beta_{T-1}(h_{T-1})B_{T-1}+\alpha_{T-1}(h_{T-1})S_{T-1}(h_{T-1})\\
        &=\frac{1}{1+r}\left( q H(h_{T-1},u) + (1-q)H(h_{T-1},d) \right)
    \end{align*}
    where \(q=\frac{1+r-d}{u-d}\). For \(T=1\), use \Cref{th:CRR_COMPLETE} and for \(T>1\) repeat the calculation recursively. The above can be seen by plugging in \(\alpha_{T-1}(h_{T-1})\) and \(\beta_{T-1}(h_{T-1})\) and obtaining \[
        V_T^\phi(h_{T-1}) = \frac{uH(h_{T-1}, u)-dH(h_{T-1},d)}{(u-d)B_T}B_{T-1}+\frac{H(h_{T-1},u)-H(h_{T-1},d)}{(u-d)S_{T-1}(h_{T-1})}S_{T-1}(h_{T-1})
    \]
    and noticing \(B_T/B_{T-1}=1/(1+r)\).
\end{proof}
\begin{remark}
    \(V_t^\phi\) is the price of \(H\) at time \(t\) and \[
        V_t^\phi = B_t \E_\Q\left( \frac{H}{B_T} \mid \cF_t \right) \leftarrow \text{cf. chapter 6}
    \]
\end{remark}
\begin{remark}[Hedging in multi-period CRR model]
    Suppose (NA) holds and \(H=h(S_T)\). If \(\phi=(\alpha,\beta)\) is a hedging strategy for \(H\), then \[
        V_T^\phi(S_{T-1}, u) = h(S_{T-1},u)=\beta_{T-1}(S_{T-1})B_T+\alpha_{T-1}(S_{T-1})S_{T-1}u
    \]
    and in the down state \[
        V_T^\phi(S_{T-1}, d) = h(S_{T-1},d)=\beta_{T-1}(S_{T-1})B_T+\alpha_{T-1}(S_{T-1})S_{T-1}d.
    \]
    We see that \(\alpha_{T-1}, \beta_{T-1}\) do depend on \(h_{T-1}\) only via \(S_{T-1}\)! Not on the whole history \(h_{T-1}=(y_1,\dots,y_{T-1})\). The same applies to \(V_{T-1}\) as \[
        V_{T-1}^\phi(S_{T-1}) = \beta_{T-1}(S_{T-1}) B_{T-1} + \alpha_{T-1}(S_{T-1}) S_{T-1}
    \]
    and \[
        \alpha_{t-1}(S_{t-1}) = V_t^\phi(S_{t-1},u) + V_t^\phi(S_{t-1},d)
    \]
    and \[
        \beta_{t-1}(S_{t-1}) = \frac{u V_t^\phi(S_{t-1},d)-dV_t^\phi(S_{t-1},u)}{(u-d)B_t}.
    \]
\end{remark}
\begin{corollary}\label{cor:priceViaBinomialSum}
    Let \(H=h(S_T)\). Then \[
        \pi(H)=\E_\Q\frac{h(S_T)}{B_T}=\frac{1}{B_T}\sum_{t=0}^T {T \choose t} q^t(1-q)^{T-t}h(S_0 u^t d^{T-t})
    \]
\end{corollary}
\begin{proof}
    \(S_T=S_0\prod_{t=1}^TY_t\)
    with \(\Q(Y_t=u)=q=1-\Q(Y_t=d)\). The number of "ups" up to time \(T\) is binomially distributed with parameters \(T,q\). The payoff \(H\) is therefore the same for \({T \choose t}\) realisations. The sum from Theorem 3.4 is given by the above binomial expression.
\end{proof}
\begin{example}
    CRR model with \(T=10\). Let \(r=0.02\), \(u=1.1\), \(d=0.9\), \(S_0=100\), call option with \(K=220\). Moreover \(H = (S_T-K)^+\). We are interested in the price of this option at \(t=0\) and \(\alpha_0, \beta_0\). Note that \(K=220\) is very high. Only in the case \(\omega=(u, \dots, u)\) we obtain a positive payoff \(H(u, \dots, u) = (S_0 u^{10}-K)^+ = 39.37\). Corollary 3.11 tells us \(\pi(H)=\E_\Q\frac{H}{B_T}=\left(\frac{q}{1+r}\right)^{10}=0.195\) with \(q=\frac{1+r-d}{u-d}=0.6\). Our hedging strategy is determined by
    \[
        K=220 \implies 
        \begin{cases}
            V_1^\phi(d)=0\\
            V_1^\phi(u)=\left(\frac{q}{1+r}\right)^{9},\, H(u, \dots, u)=0.332
        \end{cases}
    \]
    and hence \(\alpha_0 S_0 u + \beta_0 B_1 = 0.332u\) and \(\alpha_0 S_0 d + \beta_0 B_1 = 0\). Solving for \(\alpha_0, \beta_0\) we get \(\alpha_0=0.0166, \beta_0=-1.464\).
\end{example}

\subsection{The limit \texorpdfstring{\(n \to \infty\)}{}: Black-Scholes Model.}

\(H = h(S_T) = (S_T-K)^+\) and by \Cref{cor:priceViaBinomialSum}
\begin{align*}
    C_0 &= \frac{1}{B_T} \sum_{t=0}^T {T \choose t} q^t(1-q)^{T-t}(S_0 u^t d^{T-t}-K)^+\\
    &= \frac{1}{B_T}\sum_{k=a}^T {T \choose k}q^k(1-q)^{T-k}(S_0u^kd^{T-k}-K)\\
    &= S_0 \sum_{k=a}^T {T \choose k} \left(\frac{q^k}{1+r}\right)^k \left(\frac{(1-q)d}{1+r}\right)^{T-k}-\frac{K}{(1+r)^T}\sum_{k=a}^T {T \choose k} q^k (1-q)^{T-k}\\
    &= S_0 \sum_{k=a}^T {T \choose k} \left(\frac{qu}{1+r}\right)^k\left(1-\frac{qu}{1+r}\right)^{T-k}-\frac{K}{(1+r)^T}\sum_{k=a}{T \choose k} q^k (1-q)^{T-k}
\end{align*}
by choosing \(a = \min\set{ k \in \N : S_0u^t d^{T-t}-K > 0 }\) and some factoring and collecting terms and noticing \(q=\frac{1+r-d}{u-d} \implies \frac{(1-q)d}{1+r}=1-\frac{qu}{1+r}\). Now divide \([0, T]\) into parts of length \(\Delta_n = T/n\) and consider a sequence of CRR models with parameters \(d_n, u_n, r_n\). Interest in \(n\) periods is \[
    \left(1+\frac{r}{n}\right)^n \stackrel{n \to \infty}{\longrightarrow} e^r.
\]
Choosing \(r_n\) such that \(1+r_n = e^{r \Delta_n}\) implies \(B_t=(1+r)^t=e^{rt\Delta_n}\). Choose \(r_n=e^{r \Delta_n}-1\) and \(u_n=e^{\sigma \sqrt{\Delta_n}}\) and \(d_n=u_n^{-1}=e^{-r\sqrt{\Delta_n}}\). For large \(n\) we obtain \(e^{-\sigma{\sqrt{\Delta_n}}} < 1+r_n < e^{\sigma\sqrt{\Delta_n}}\) and hence (NA). This can be seen from \[
    -\sigma\sqrt{\Delta_n} < \log(1+r_n) = r\Delta_n < \sigma\sqrt{\Delta_n}.
\]
\begin{theorem}[Black-Scholes formula is CRR limit]\label{th:BLACKSCHOLES_CRR}
    The time-\(0\) price of a European call option is given by \[
        C_0^{BS} = \lim_{h \to \infty} C_0^{(h)} = S_0 \Phi(d) - Ke^{-rT}\Phi(d-\sigma\sqrt{T})
    \]
    with \(d=\frac{\log\frac{S_0}{K}+(r+\sigma^2/2)T}{\sigma\sqrt{T}}\) where \(\Phi\) is the CDF of the standard normal distribution.
\end{theorem}
\begin{remark}
    \(r\) is the interest in the continuous model. \(\sigma\) is the volatility of the stock, i.e.\ a measure of the size of the fluctuations of the stock price. \(S_0\) is the stock price at time \(0\). \(K\) is the strike price at \(t=T\).
\end{remark}
\begin{proof}
    Consider again the \(n\)-period CRR model and set \[
        a_n=\min \set{k \in \N_0: S_0u_n^kd_n^{n-k}-K>0}
    \] and \(q_n\frac{1+r_n-d_n}{u_n-d_n}\). Then \[
        C_0^{(n)} = S_0 \sum_{k=a_n}^n {n \choose k} \left(\frac{q_nu_n}{1+r_n}\right)^{k} \left(1-\frac{q_nu_n}{1+r_n}\right)^{n-k}-\frac{K}{(1+r_n)^n}\sum_{k=a_n}^n {n \choose k} q_n^k (1-q_n)^{n-k}.
    \]
    with \(\hat q_n = \frac{q_n u_n}{1+r_n}\) we have \(\hat q_n \in [0,1]\) can be interpreted as a probability. Moreover, we denote by \[
        \bar B_{n,p}(x) = \sum_{k=x}^n {n \choose k} p^k (1-p)^{n-k}, \quad x \in \set{0, 1, \dots, n}
    \]
    the survival function of a binomial distribution \(B(n,p)\). Hence \[
        C_0^{(n)} = S_0 \bar B_{n, \hat q_n}(a_n) - \frac{K}{(1+r_n)^n} \bar B_{n, q_n}(a_n).
    \]
    By construction, \((1+r_n)^{-n}=e^{-r\frac{T}{n}n}=e^{-rT}\). We now need to show that \begin{align*}
        \lim_{n \to \infty} \bar B_{n, \hat q_n} (a_n) &= \Phi(d)\\
        \lim_{n \to \infty} \bar B_{n, q_n}(a_n) &= \Phi(d-\sigma\sqrt{T}).
    \end{align*}
    We only show the first equality. The latter follows analogously. Take a random variable \(Z_n \sim B(n, \hat q_n)\), i.e.\ \[
        \bar B_{n,\hat q_n}(a_n) = \P(a_n \leq z_n \leq n).
    \]
    Now, we want to apply the CLT of Lindeberg-Feller. First, we standardise the random variables as \[
        \tilde Z_n = \frac{Z_n - \E Z_n}{\sqrt{\var(Z_n)}} = \frac{Z_n - n \hat q_n}{\sqrt{n \hat q_n (1-\hat q_n)}}.
    \]
    Now notice \[
        a_n \leq Z_n \leq n \iff \alpha_n = \frac{a_n - n \hat q_n}{\sqrt{n \hat q_n (1- \hat q_n)}} \leq \tilde Z_n \leq \frac{n(1-\hat q_n)}{\sqrt{n \hat q_n (1-\hat q_n)}} = \beta_n.
    \]
    Moreover \[
        \bar B_{n, \hat q_n} (a_n) = \P(a_n \leq Z_n \leq n) = \P(\alpha_n \leq \tilde Z_n \leq \beta_n).
    \]
    Determine \[
        a_n = \min \set{k \in \N_0 : S_0 u_n^k d_n^{n-k} - K > 0}.
    \]
    We know \(S_0u_n^kd_n^{n-k}-K>0 \iff k > \frac{\log (K/S_0)-n\log(d_n)}{\log(u_n/d_n)}=a_n\). We have \[
        \log\frac{u_n}{d_n}=\log \left(\frac{e^{\sigma{\sqrt{\Delta_n}}}}{e^{-\sigma\sqrt{\Delta_n}}}\right) = 2 \sigma\sqrt{\Delta_n}
    \]
    and \[
        \log(d_n)=-\sigma\sqrt{\Delta_n}.
    \]
    Moreover, \(\lim_n q_n = \lim_n \hat q_n = 1/2\) and \(\lim_n n(1-2\hat q_n)\sqrt{\Delta_n}=-T\left(\frac{r}{\sigma}+\frac{\sigma}{2}\right)\).
    We have \begin{align*}
        \lim_n \alpha_n
        &= \lim_n \frac{a_n - n \hat q_n}{\sqrt{n \hat q_n (1-\hat q_n)}}\\
        &= \lim_n \frac{\frac{\log (K/S_0)-n\log(d_n)}{\log(u_n/d_n)}-n \hat q_n}{\sqrt{n \hat q_n (1-\hat q_n)}}\\
        &= \lim_n \frac{\log(K/S_0) + n \sigma \sqrt{\Delta_n} - \sigma n \sqrt{\Delta_n} 2 \hat q_n}{\sqrt{n \hat q_n (1-\hat q_n)\Delta_n} 2 \sigma}\\
        &= \frac{\log (K/S_0) - \sigma T\left(\frac{r}{\sigma}+\frac{\sigma}{2}\right)}{\sigma \sqrt{T}} = \frac{\log(K/S_0)-T(r+\frac{\sigma^2}{2})}{\sigma \sqrt{T}}=-d.
    \end{align*}
    Analogously, compute \(\lim_n \beta_n = \infty\). Then, apply the CLT by Lindeberg-Feller and obtain \[
        \lim_n \bar B_{n, \hat q_n}(a_n) = \Phi(\lim_n \beta_n)-\Phi(\lim_n \alpha_n) = 1 - \Phi(-d) = \Phi(d).
    \]
    One analogously obtains \[
        \lim_n \bar B_{n, q_n}(a_n) = \Phi(d-\sigma\sqrt{T}).\qedhere
    \]
\end{proof}
We state the CLT for completeness.
\begin{theorem}[Lindeberg-Feller]\label{thm:lindebergFeller}
    For \(n \in \N\) and \(X_{n_1}, \dots, X_{n r_n}\) independent with \(\E X_{n_k} = \mu_{n_k}\) and \(0 < \var(X_{n_k}) < \sigma_{n_k}^2 < \infty\). Let \(\sigma_n^2 = \sigma_{n_1}^2 + \cdots + \sigma_{nr_n}^2\). If the Lindeberg condition \[
        \lim_{n \to \infty} \frac{1}{\sigma_n^2} \sum_{k=1}^{r_n} \E \left( X_{n_k}-\mu_{n_k} \right)^2 \indic[\abs[X_{n_k}-\mu_{n_k}] > \epsilon \sigma_n] = 0
    \]
    is satisfied, then for \(S_n = X_{n_1} + \cdots + X_{nr_n}\), \[
        \lim_{n \to \infty} \Pr\left( \frac{S_n - \E S_n}{\sqrt{\var\left(S_n\right)}} \leq x \right) = \Phi(x), \quad \forall x \in \R.
    \]
    If \((\alpha_n) \subseteq \R\) and \(\beta_n \subseteq \R\) are sequences with \(\lim_n \alpha_n = \alpha\), \(\lim_n \beta_n = \beta\) with \(\alpha \leq \beta\) we have \[
        \lim_{n \to \infty} \Pr \left( \alpha_n \leq \frac{S_n - \E S_n}{\sqrt{\var(S_n)}} \leq \beta_n \right) = \Phi(\beta) - \Phi(\alpha).
    \]
\end{theorem}
One may verify the conditions on the statement for the proof of~\cref{th:BLACKSCHOLES_CRR}.

\newpage
\section{Absence of arbitrage and equivalent martingale measures}
We use the abbreviation EMM for ''equivalent martingale measure''.
We already saw such measures as the \(q\)'s appearing in the previous chapters.
We will now connect (NA) and the set of EMMs.
For this, we continue with finite state financial markets equipped with a filtered probability space \((\Omega, \cF, \P)\) and assume \(\P(\set{\omega}) > 0\) for each \(\omega \in \Omega\). We again let \(\cF_0 = \set{\Omega, \emptyset}\) and \(\cF_T = \cF = 2^\Omega\).

\begin{definition}[Martingale Measure]\label{def:martingaleMeasure}
    A probability measure \(\Q\) on \((\Omega, \cF, (\cF_t)_t)\) is called \underline{martingale measure} or \underline{risk-neutral} if for all \(k=1, \dots, d\), the discounted price process \((\tS_t^k) = (S_t^k/B_t)\) are \((\cF_t)_t\)-martingales.
\end{definition}
The latter means \[
    \tS_t^k = \E_\Q\left( \tS_{t+1}^k \mid \cF_t \right) \quad \Q\text{-a.s. for all }k=1,\dots,d.
\]
\begin{remark}[Notation]
    We let \[
        \cM \defn \set{\Q \text{ is a probability measure on } (\Omega, \cF) \text{ and } \Q \text{ is a martingale measure}}.
    \]
    We let \[
        \cM^+ \defn \set{\Q \in \cM: \Q \text{ is equivalent to } \P}
    \]
    where equivalence of measures means that they have the same null sets.
\end{remark}
Consider the CRR-model under (NA). Recall the condition \(d < 1+r < u\), then we defined \[
    \Q(\set{\omega})=\Q(\set{y_1, \dots, y_T}) = q_{y_1} \cdot \cdots \cdot q_{y_T},
\]
\(\omega=(y_1, \dots, y_T) \in \set{u,d}^T\) and \[
        q_y = \begin{cases}
        q &y=u\\ 1-q &y=d
    \end{cases}
\]
with \(q=\frac{1+r-d}{u-d}\) and \(\cF_t = \sigma(Y_1, \dots, Y_t) = \cF_t^S\). We will now show that \(\Q\) is an EMM.

\begin{theorem}[Equivalences under (NA)]\label{thm:equivEMMCrr}
    Under (NA) in the CRR-model,
    \begin{itemize}
        \item \((\tS_t)\) is a \(\Q\)-martingale, i.e.\ \(\Q \in \cM\),
        \item \(\Q\) is the only martingale measure , i.e.\ \(\abs[\cM]=1\),
        \item \(\Q\) is equivalent to \(\P\), i.e.\ \(\abs[\cM^+]=1, \Q \in \cM^+\).
    \end{itemize}
\end{theorem}
\begin{proof}
    Ad (a). \begin{align*}
        \E_\Q \left(\tS_{t+1} \mid \cF_t\right)
        &= \E_\Q \left( \frac{Y_{t+1}S_t}{B_t} \mid \cF_t \right)\\
        &= \frac{S_t}{B_{t+1}}\E_\Q\left( Y_{t+1} \mid \cF_t \right)\\
        &= \frac{S_t}{B_t(1+r)}\E_\Q Y_{t+1}\\
        &= \frac{S_t}{B_t}\frac{1}{1+r}\left( uq+d(1-q) \right)\\
        &= \frac{S_t}{B_t} = \tS_t
    \end{align*}
    by definition of \(\tS_{t+1}\) and measurable factorisation since \(S_t\) is \(\cF_t\)-measurable and \(B_{t+1}\) is deterministic and \(Y_{t+1} \perp \cF_t\). In the last step, we used that \((uq+d(1-q))/(1+r)=1\) since \(q=(1+r-d)/(u-d)\).

    Ad (b). Arguments after~\cref{th:CRR_COMPLETE} apply. \(\Q\) is the only one which achieves the goal, i.e.\ such that (a) holds, we obtain the unique solution for \(q\).

    Ad (c). With (NA), \(q \in (0,1)\) implies that \(\Q(\set{\omega})>0\) for all \(\omega \in \Omega\) implies \(\Q\) is equivalent to \(\P\).
\end{proof}

From now on, consider the general finite financial market. The question arises, how (NA) and \(\abs[\cM]\) are related.

\begin{theorem}\label{thm:wealthMartingale}
    Let \(\Q \in \cM\) and \(\phi = (\alpha, \beta)\) be a self-financing trading strategy. Then the discounted stock wealth process \(\left(\frac{V_t^\phi}{B_t}\right)\)  is a \(\Q\)-martingale.
\end{theorem}
\begin{proof}
    As \(\phi\) is self-financing, we have by~\cref{le:SELFF_TO_BETA}, \[
        \frac{V_t^\phi}{B_t} = V_0^\phi + G_t^\alpha = V_0^\phi + \underbrace{\sum_{k=1}^d \underbrace{\sum_{n=1}^t \alpha_{n-1}^k \Delta \tS_n^k}_{\text{martingale transformation of } \Q \text{-martingales } \tS_t}}_{\text{sum of martingale transformations}}.
    \]
    Hence, \(\frac{V_t^\phi}{B_t}\) is again a \(\Q\)-martingale.
\end{proof}

\begin{theorem}\label{thm:EMMAdmissibleEquivalence}
    Let \(\Q\) be a probability measure on \((\Omega, \cF)\). We have
    \begin{itemize}
        \item \(\Q \in \cM\) if and only if for all \(\alpha \in \cA: \E_\Q(G_T^\alpha)=0\),
        \item if \(\cM^+ \neq \emptyset\), then (NA).
    \end{itemize}
\end{theorem}
\begin{proof}
    Ad (a). Let \(\Q \in \cM\). Then we have \begin{align*}
        \E_\Q \left( \alpha_{t-1} \cdot \Delta \tS_t \mid \cF_{t-1} \right)
        &= \alpha_{t-1} \E_\Q\left( \Delta \tS_t \mid \cF_{t-1} \right)\\
        &= \alpha_{t-1} \E_\Q \left( \tS_t-\tS_{t-1} \mid \cF_{t-1} \right)\\
        &= \alpha_{t-1} \E_\Q \left( \tS_t \mid \cF_{t-1} \right) - \alpha_{t-1} \E_\Q \left( \tS_{t-1} \mid \cF_{t-1} \right)\\
        &= \alpha_{t-1} \tS_{t-1} - \alpha_{t-1} \tS_{t-1} = 0
    \end{align*}
    by the martingale property and the \(\cF_{t-1}\)-measurability of \(\tS_{t-1}\) for any \(t=1, \dots, T\).

    Moreover \[
        \E_\Q \left( \alpha_{t-1} \cdot \Delta \tS_t \mid \cF_{t-1} \right) = \E_\Q \left( \E_\Q \left( \alpha_{t-1} \cdot \Delta \tS_t \mid \cF_{t-1} \right) \right) = 0.
    \]
    This implies \[
        \E_\Q G_T^\alpha = \E_\Q\left( \sum_{t=1}^T \alpha_{t-1} \cdot \Delta \tS_t \right) = 0.
    \]

    For the backwards direction, let \(n \in \set{1, \dots, T}\) and \(k \in \set{1, \dots, d}\) and \(B \in \cF_{n-1}\). Define the trading strategy \(\alpha = (\alpha_t)\) s.t.\ \[
        \alpha_{n-1}^k = \indic_B, \quad \alpha_t^j = 0, \text{for } (j,t) \neq (k, n-1).
    \]
    Now, \(\alpha \in \cA\) as \(\alpha_t\) is \(\cF_t\)-measurable. Now, \[
        G_T^\alpha = \indic_B \Delta \tS_n^k
    \]
    and by assumption, \[
        0 = \E_\Q G_T^\alpha = \E_\Q \left( \indic_B \Delta \tS_n^k \right).
    \]
    By construction, \(\indic_B\) is \(\cF_{n-1}\)-measurable and \[
        0 = \E_\Q \left( \indic_B \Delta \tS_n^k \right) = \E_\Q \left( \E_\Q \left( \indic_B \Delta \tS_t^k \mid \cF_{n-1} \right) \right) = \E_\Q \left( \indic_B \E_\Q \left( \Delta \tS_n^k \mid \cF_{n-1} \right) \right).
    \]
    Now choose \(B = \set{\E_\Q(\Delta \tS_n^k \mid \cF_{n-1}) \stackrel{>}{<} 0}\) to get \[
        0 = \E_\Q \left( \indic_B \Delta \tS_n^k \right) = \Q(B).
    \]
    This implies \(\E_\Q (\Delta \tS_n^k \mid \cF_{t-1})=0\) \(\Q\)-a.s. for all \(n,k\) and hence \(\Q \in \cM\).

    Ad (b). First, we characterise (NA) as in chapter 2. There, we said that for a self-financing trading strategy \(\phi = (\alpha, \beta)\), (NA) \(\iff\) \(G_T^\alpha \geq 0\) implies \(G_T^\alpha=0\).

    (A) means that there is a self-financing \(\phi=(\alpha, \beta)\) s.t.\ \[
        V_0^\phi = 0,\quad \P\left( G_T^\alpha \geq 0 \right), \quad \P\left(G_T^\alpha > 0\right)> 0.
    \]
    We know from part (a) that \(\E_\Q(G_T^\alpha)=0\) for all \(\alpha \in \cA\). If \(G_T^\alpha \geq 0\) and \(\E_\Q(G_T^\alpha) = 0\) implies \(G_T^\alpha=0\) since every atomic event has positive \(\Q\)-probability.
\end{proof}

The first fundamental theorem of asset pricing yields a clear connection between EMMs and (NA). Indeed, (NA) \(\iff\) \(\cM^+ \neq \emptyset\). The proof is based on a separation theorem in \(\R^m\) and relies on methods from functional analysis. Essentially, we exploit the fact that \(\Omega = \set{\omega_1, \dots, \omega_m}\) is finite. We now interpret the random variable \(X\) on \(\Omega\) as a vector in \(\R^{\abs[\Omega]} = \R^m\) by writing \((X(\omega_1), \dots, X(\omega_m)) \in \R^m\) and we denote \(X(\omega_i)\) by \(X_i\). Consider the set \[
    L = \set{X \in \R^m: X_i = G_T^\alpha(\omega_i), i=1,\dots,m,\, \alpha \in \cA}.
\]
The \(G_T^\alpha\) is linear in \(\alpha\). Hence, \(L\) is a linear subset of \(\R^m\) which is closed and convex.

\begin{remark}[Interpretation of \(L\)]
    Recall that \(H\) is attainable if \(V_T^\phi = H\). Then \(\pi(H) = V_0^\phi\) for \(\phi\) self-financing. By~\cref{le:22} we have \[
        \frac{V_T^\phi}{B_T} = V_0^\phi + \sum_{n=1}^T \alpha_{n-1} \Delta \tS_n = V_0^\phi + G_T^\alpha.
    \]
    \(L\) includes all discounted contingent claims, that are attainable and have price \(0\). This can be seen since with \(V_0^\phi=0\) implies \(G_T^\alpha=V_T^\phi/B_T=H/B_T\)
\end{remark}

Define \[
    \cC = \set{X \in \R^m : X \leq Y \text{ for some } Y \in L}.
\]
This is a convex and closed cone that includes all vectors that are dominated by discounted claims with price \(0\). We can equivalently express (NA) with the help of the sets \(L\) and \(\cC\). Indeed, \[
    L \cap \R^m_+ = \set{0}, \text{ resp. } \cC \cap \R^m_+ = \set{0}.
\]
The above means that we start from initial investment \(0\) i.e.\ from \(L\) or \(\cC\). The resulting contingent claim \(H/B_T\) is non-negative and not identically equal to \(0\), i.e.\ \(L \setminus \cC \cap \R^m_+\) is not allowed to happen.
Recall, arbitrage opportunities are defined by \[
    V_0^\phi = 0,\quad \P(V_T^\phi \geq 0) = 1,\quad \P(V_T^\phi > 0) > 0.
\]
Hence, (NA) exactly means \(L \setminus \cC \cap \R^m_+ = \set{0}\).

\begin{lemma}[First fundamental theorem of asset pricing]\label{lem:firstFundamental}
    For any \(Z \notin \cC\), there exists a martingale measure \(\Q \in \cM\) such that \(\E_\Q(Z) > 0\).
\end{lemma}
In words, for every such random variable \(Z\), i.e.\ that is not dominated by discounted claims with price \(0\) there exists \(\Q \in \cM\) with \(\E_\Q(Z) > 0\). To show this, we need the following separation theorem. For this, recall that a set \(K \subseteq \R^n\) is convex if for all \(x,y \in K, \lambda \in [0,1]: \lambda x + (1-\lambda)y \in K\).
\begin{lemma}[Separation Lemma]\label{lem:separation}
    Let \(K\) be closed, convex and non-empty and let \(Z \notin K\). Then there exists a linear \(f: \R^n \to \R\) and \(\gamma \in \R\) such that \(f(x) \leq \gamma\) for all \(x \in K\) and \(f(Z) > \gamma\).
\end{lemma}
We do not prove this here.

\begin{proof}[Proof of~\cref{lem:firstFundamental}]
    We observe that \(\cC\) is closed and convex. By~\cref{lem:separation} we deduce that there is a linear mapping \(f(x) = ax, a \in \R^m\) and \(\gamma \in \R\) with \[
        \sum_{i=1}^m a_i H_i \leq \gamma < \sum_{i=1}^m a_i Z_i.
    \]
    In particular, \(0 \in \cC\). Hence \(0 \leq \sum_{i=1}^m a_i Z_i\). Hence, we may choose \(\gamma=0\). Now consider \(\indic[\omega_i]\). We have \(-\indic[\omega_i] \leq 0 \leq G_T^0 \implies -\indic[\omega_i] \in \cC\) for all \(\omega_i\). Thus \(- a_i \leq 0\)
    and \(\sum_{i=1}^m a_i > 0\) as \(a_i \neq 0\) since \(0 < \sum_{i=1}^m a_i Z_i\) by the second part of the separation theorem. We may construct a probability measure \(\Q(\set{\omega_i}) = \frac{a_i}{\sum_{j=1}^m a_j}\). This is our candidate for the EMM. Indeed, this \(\Q\) is in \(\cM\) since \(\pm G_T^\alpha = G_T^{\pm \alpha}\) (the gains process is linear in \(\alpha\)) and hence \(\pm G_T^\alpha = G_T^{\pm \alpha} \in \cC\) by construction. Again, by the separation theorem \[
        \pm G_T^\alpha \leq 0\quad \forall i \implies \E_\Q G_T^\alpha = \frac{1}{\sum_{j=1}^m a_j} \sum_{i=1}^m a_i G_T^\alpha(\omega_i) \leq 0.
    \]
    The same holds for \(-\E_\Q G_T^\alpha \leq 0\) and hence \(\E_\Q G_T^\alpha = 0\) for all \(\alpha \in \cA\). We observe that \(\E_\Q(Z) = \frac{1}{\sum_j a_j} \sum_i a_i Z_i > 0\).
\end{proof}

\begin{remark}
    With the help of the set \(L\), we may hence write \[
        \Q \in \cM \iff \E_\Q X = 0,\quad \forall X \in L.
    \]
    \(\cC\) consists of elements that are dominated by \(L\) and by monotonicity of expectation we obtain \[
        \Q \in \cM \iff \E_\Q X \leq 0,\quad \forall X \in \cC.
    \]
\end{remark}
The first fundamental theorem of asset pricing means that the following are equivalent:
\begin{itemize}
    \item (NA) holds,
    \item \(\cM^+ \neq \emptyset\), i.e.\ there exists at least one EMM.
\end{itemize}
A financial market is hence free of arbitrage if and only if there exists a probability measure \(\Q\) which is equivalent to \(\P\) and such that the discounted stock prices \((\tS_t^k)\) are martingales under \(\Q\).
To see this, use~\cref{thm:EMMAdmissibleEquivalence} to have the backward direction. For the forward direction, suppose (NA) holds. This means \[
    \cC \cap \R^m_+ = \set{0} \implies \indic[\omega] \notin \cC\,\ \forall \omega \in \Omega.
\]
\Cref{lem:firstFundamental} now yields, that there is a \(\Q_\omega \in \cM\) such that \(\E_{\Q_\omega} \indic[\omega] = \Q_\omega(\set{\omega}) > 0\). Now define a probability measure on \((\Omega, \cF)\) by \[
    \Q(\set{\omega}) = \frac{1}{m} \sum_{i=1}^m \underbrace{\Q_{\omega_i}(\set{\omega_i})}_{\in \cM\text{ and positive by~\cref{lem:firstFundamental}}}.
\]
Now, \(\Q(\set{\omega}) > 0\) for all \(\omega \in \Omega\) and \(\Q \in \cM\) as it is a convex combination of \(\Q_{\omega_i} \in \cM\). Hence \(\cM^+=\emptyset\) as \(\Q\) is equivalent to \(\P\).

\newpage
\section{Completeness and equivalent martingale measures}

We have seen that the CRR model is complete when there are no arbitrage opportunities. In general markets however, we cannot deduce completeness from (NA).

\subsection{Characterisations of complete financial markets}
We come to the second fundamental theorem of asset pricing.
\begin{theorem}[Second fundamental theorem of asset pricing]\label{thm:secondFundamental}
    Suppose (NA). Then, the financial market is complete if and only if there exists a unique EMM, i.e.\ \(\abs[\cM^+]=1\).
\end{theorem}
\begin{proof}

    (Part (a).)

    Let the market be complete. (NA) implies by the first fundamental theorem of asset pricing,~\Cref{lem:firstFundamental}, that \(\cM^+ \neq \emptyset\). Now, we show uniqueness by showing that two arbitrary elements of \(\cM^+\) are the same. Let \(\Q_1, \Q_2 \in \cM^+\). Let \(H\) be an arbitrary contingent claim and \(\phi = (\alpha, \beta)\) be a corresponding hedging strategy which exists since we assumed completeness. Then \[
        \frac{H}{B_T} = V_0^\phi + G_T^\alpha \implies \E_{\Q_1}G_T^\alpha = \E_{\Q_2} G_T^\alpha=0
    \]
    by~\Cref{thm:EMMAdmissibleEquivalence} and since \(H\) is arbitrary, \(\Q_1=\Q_2\) and thus \(\abs[\cM^+]=1\)
    
    (Part (b).)

    Let the market be incomplete. We show \(\abs[\cM^+] > 1\). Recall that we identify random vectors with \[
        X = (X(\omega_1), \dots, X(\omega_m)) \in \R^m,\, X_i = X(\omega_i).
    \]
    Now let \[
        L \defn \set{X \in \R^m \mid X_i = c+G_T^\alpha(\omega_i),\, i=1,\dots,m, c \in \R^m, \alpha \in \cA}
    \]
    be the set of discounted claims that are attainable. (NA) and the first fundamental theorem of asset pricing imply \(\cM^+ \neq \emptyset\). Let now \(\Q \in \cM^+\) and \(\Q(\set{\omega_i}) = q_i\) for \(i=1,\dots,m\). For random variables \(Z, Y\) on \(\Omega\) we consider the scalar product \[
        \inn[Z][Y] = \E_\Q\left(Z \cdot Y\right) = \sum_{i=1}^m Z_i Y_i q_i.
    \]
    By assumption, there exists a non-attainable claim \(H\), i.e.\ \(H/B_T \in \R^m\) but \(H/B_T \notin L\).
    L is however a real subspace of \(\R^m\) and the complement is non-trivial, i.e.\ there is \(Z \in L^\perp\) with \(Z \neq 0\) such that \[
        \inn[Z][Y] = \sum_{i=1}^m Z_i Y_i q_i = 0\quad \forall Y \in L.
    \]
    Since \(1, \dots, 1 \in L\), this means \(\sum_{i=1}^m Z_i q_i = 0\). Now, define a new probability measure \(\Q' \neq \Q\) and show that \(\Q' \in \cM^+\). Hence, let \(\Q'(\set{\omega_i})=\left(1+\frac{Z_i}{2\norm[Z]}q_i\right)\) for all \(i\) and \(\norm[Z]=\max_{1 \leq i \leq m} \abs[Z_i]\). \(\Q'\) is indeed a probability measure since \[
        \Q'(\Omega) = 1 + \frac{1}{2\norm[Z]} \underbrace{\sum_{i=1}^m Z_i q_i}_{=0} = 1.
    \]
    In particular, \(\Q'\) is equivalent to \(\P\) since singletons have positive weight. It is left to show that \(\Q \in \cM\) as well. For that, we use again~\Cref{thm:EMMAdmissibleEquivalence}. Let \(Y = (c+G_T^\alpha(\omega_1),\dots,c+G_T^\alpha(\omega_m)) \in L\) be arbitrary. Now,
    \begin{align*}
        c + \E_{\Q'} G_T^\alpha = \E_{\Q'} Y &= \sum_{i=1}^m Y_i \Q'(\set{\omega_i})\\
        &= \sum_{i=1}^m Y_i\left( 1 + \frac{Z_i}{2\norm[Z_i]} \right)q_i\\
        &= \sum_{i=1}^m Y_i q_i + \frac{1}{2\norm[Z]} \underbrace{\sum_{i=1}^m Y_i Z_i q_i}_{=0\,\ \forall Y \in L}\\
        &= \E_\Q Y = c + \E_\Q G_T^\alpha = c.
    \end{align*}
    Hence, \(\Q' \in \cM\) and the equivalence to \(\P\) implies \(\Q' \in \cM^+\).
\end{proof}
\begin{remark}
    A necessary condition for the completeness of a financial market is \(\cF_t = \cF_t^S\) for any \(t\). Otherwise, there exists a timestamp \(t\) and \(A \in \cF_t\) such that \(A \notin \cF_t^S\). Define \(H = \indic_A\), then \(H\) is not attainable. This is a serious restriction: the filtration can thus not contain further information about economic factors.
\end{remark}
We can also characterise completeness via martingale properties.
\begin{theorem}\label{thm:characterisationViaMartingaleProperties}
    Suppose (NA) holds and let \(\Q \in \cM^+\). Then, the market is complete if and only if any \((\cF_t)\)-martingale \((M_t)\) w.r.t.\ \(\Q\) has the representation \[
        M_t = M_0 + \sum_{n=1}^t \alpha_{n-1} \Delta \tS_n,\quad t=0,\dots,T
    \]
    for an \((\cF_t)\)-adapted process \((\alpha_t)\).
\end{theorem}
\begin{proof}
    Let the market be complete. \(H = M_T B_T\) is an \(\cF_T\)-measurable claim. Hence, there exists a self-financing strategy \(\phi = (\alpha, \beta)\) such that \(V_T^\phi = H = M_TB_T\) and respectively \(V_T^\phi/B_T=M_T\). By~\Cref{thm:wealthMartingale}, the discounted wealth process is a \(\Q\)-martingale. But by assumption, \((M_t)\) is a \(\Q\)-martingale as well, i.e.\ \[
        \frac{V_T^\phi}{B_T} = \E_\Q \left(\frac{H}{B_T} \mid \cF_t\right) = \E_\Q \left(M_T \mid \cF_t\right) = M_t.
    \]
    \Cref{le:22} asserts that \[
        \frac{V_t^\phi}{B_t} = V_0^\phi + G_t^\alpha = \underbrace{V_0^\phi}_{=M_0} + \sum_{n=1}^t \alpha_{n-1} \Delta \tS_n = M_t.
    \]
    Now to the backward direction. Define \(M_t = \E_\Q\left(H/B_T \mid \cF_t\right)\) for any \(t=0,\dots,T\). This is a Doob-martingale, recall \(X \in \cF\), then \(X_t = \E(X \mid \cF_t)\) is a \((\cF_t)\)-martingale.
    Hence, \(M_t\) is a \((\cF_t)\)-martingale under \(\Q\) and \(V_0^\phi=u_0 \in \R\) and there exists \(\alpha\) such that \[
        M_t = M_0 + \sum_{n=1}^t \alpha_{n-1}\Delta \tS_n = V_t^\phi + G_t^\alpha = \frac{V_t^\phi}{B_t}
    \]
    again by~\Cref{le:22}. Hence \(H/B_t=M_t=V_t^\phi/B_t\) and the market is complete.
\end{proof}

\subsection{Computation of martingale measures}

In the CRR model, \(\Q\) could be explicitly determined. How do the measures look like in more general financial markets (if they exist)? We mimic the procedure from the CRR model. Hence, consider the following product space for the price process of the risky asset: \[
    \Omega = \Omega_1 \times \cdots \times \Omega_T
\]
where \(\Omega_t\) is the finite set of all possible states in period \(t\). Let now \(Y_t\) be the projection onto \(\Omega_t\), i.e.\ \(Y_t(\omega)=y_t\) for any \(\omega \in \Omega\) and \(h_t=(y_1,\dots,y_t)\) is the history until time \(t\). In the CRR model we had \(\Omega_t = \set{u,d}\). Our sigma-algebra at time \(t\) is \(\cF_t = \sigma(Y_1, \dots, Y_t)\) and \(S_t \in \cF_t\) means that, by the factorisation lemma, there exists a function \(s_t = s_t(Y_1, \dots, Y_t)\). Every probability measure \(\Q\) on \((\Omega, \cF)\) can be factorised using transition kernels, i.e.\ \[
    \Q(\set{\omega})=q_1(y_1)q_2(y_2 \mid y_1) \cdot \cdots \cdot q_T(y_T \mid h_{T-1})
\]
where \(q_t(y_t \mid h_{t-1})\) is the probability that \(y_t\) is realised at \(t\) given that \(h_{t-1}\) has been realised so far. In the CRR model, \(q_t(u \mid h_{t-1}) = q = \frac{1+r-d}{u-d}\), i.e.\ the transition probabilities do not depend on the history. Now, these transition probabilities may differ.
\color{red}Here, a tree is supposed to go.\color{black}\ Under \(\Q \in \cM\), we know \[
    \E_\Q(\Delta \tS_t^k \mid \cF_{t-1})=0
\]
and hence \(0 = \int_A \Delta \tS_t^k\ \mathrm{d} \Q\) for all \(A \in \cF_{t-1}\) and \(t,k\). Hence \[
    0 = \sum_{y \in \Omega_t} \Delta \tS_t^k(h_{t-1}, y) q_t(y \mid h_{t-1}).
\]
We see that we may determine \(\Q \in \cM\) by determining the conditional probabilities \(q_t(y \mid h_{t-1})\) from the system of equations.
\begin{align}\label{ali:systemOfEquations}
    \begin{split}
        \sum_{y \in \Omega_t} q_t(y \mid h_{t-1}) \Delta \tS_t^k(h_{t-1}, y) &= 0\\
        \sum_{y \in \Omega_t} q_t (y \mid h_{t-1}) &= 1
    \end{split}
\end{align}
gives us \(d+1\) equations for every risky asset \(k=1,\dots,d\) and \(t=1,\dots,T\). The system for fixed \(t\) and \(h_{t-1}\) has exactly \(d+1\) equations and \(\abs[\Omega_t]\) unknowns (\(y \in \Omega_t\)).
A unique solution of this does exist, when for all \(h_{t-1} \in \Omega\), the vectors \[
    (\Delta \tS_t^k(h_{t-1},y), y \in \Omega_t) \in \R^{\abs[\Omega_t]}
\]
and \((1,\dots,1) \in \R^{\abs[\Omega_t]}\) are linearly independent and \(d+1=\abs[\Omega_t]\). The rule of thumb is that a unique martingale measure does in general only exist if \(\abs[\Omega_t]=d+1\), i.e.\ the number of all assets is equal to the number of possible market states. If for the solution, also \(q_t(y \mid h_{t-1}) > 0\) holds, then \(\Q \in \cM^+\) and thus (NA) holds. We recall that in the CRR model, \(\abs[\Q_t]=\abs[\set{u,d}]=2\) is the number of assets (i.e.\ stock + MMA). Moreover, \(((d-1)t, (u-1)t)\) and \((1+r, 1+r)\) are linearly independent if \(d < 1 + r < u\). Hence, the CRR model is free of arbitrage and complete.
\begin{example}
    Consider \(T=2\) periods with one riskless asset and \(B_0=B_1=B_2=1\). The stock behaves as
    \color{red}Tree here again.\color{black}
    We have \(\Omega = \set{u_1,d_1} \times \set{u_2,d_2}\) and \(\Q\) is a function as \(\Q(\set{y_1, y_2})=q_1(y_1)q_2(y_2\mid y_1)\). At \(t=1\), by~\cref{ali:systemOfEquations}, \(
        q_1(u_1)(6-4)+q_1(d_1)(3-4)=0
    \) and \(
        q_1(u_1)+q_1(d_1)=1
    \).
    This implies \(q_1(u_1)=1/3\) and \(q_1(d_1)=2/3\). At time \(t=2\), the upper node yields \(q_2(u_2 \mid u_1)(8-6)+q_2(d_2 \mid u_1)(5-6)=0\) and \(q_2(u_2 \mid u_1) + q_2(d_2 \mid u_1)=1\) finally yields \(q_2(u_2 \mid u_1) = 1/3\) and \(q_2(d_2 \mid u_1) = 2/3\). The lower node yields \(q_2(u_2 \mid d_1)(4-3)+q_2(d_2 \mid d_1)(2-3)=0\) and \(q_2(u_2 \mid d_1) + q_2(d_2 \mid d_1)=1\) gives \(q_2(u_2\mid d_1) = 1/2\) and \(q_2(d_2 \mid d_1) = 1/2\). In total,
    \begin{align*}
        \Q(\set{u_1,u_2})&=q_1(u_1)q_2(u_2 \mid u_1) = \frac{1}{3}\frac{1}{3}=\frac{1}{9}\\
        \Q(\set{u_1,d_2})&=q_1(u_1)q_2(d_2 \mid u_1) = \frac{1}{3}\frac{2}{3}=\frac{2}{9}\\
        \Q(\set{d_1,u_2})&=q_1(d_1)q_2(d_2 \mid d_1) = \frac{2}{3}\frac{1}{2}=\frac{1}{3}\\
        \Q(\set{d_1,d_2})&=q_1(d_1)q_2(d_2 \mid d_1) = \frac{2}{3}\frac{1}{2}=\frac{1}{3}.
    \end{align*}
    We notice that the total mass is \(1\). \underline{Summary:} All linear systems of equations are uniquely solvable and \(\Q(\set{\omega}) > 0\) for all \(\omega \in \Omega\). Hence there exists a unique equivalent martingale measure and by the second fundamental theorem, the market is complete and satisfies (NA).
\end{example}

\begin{example}
    \color{red}We start with a modified tree from the previous example.\color{black}

    We now have \(\Omega = \set{u_1,d_1} \times \set{u_2,m_2,d_2}\) and hence \(\Q(\set{y_1,y_2})=q_1(y_1)q_2(y_2 \mid y_1)\) with \(\P(\set{d_1,m_2})=0 \implies \Q(\set{d_1,m_2})=0\). Now, only the system of equations at \(t=2\), upper node has to be altered. Indeed,
    \[
        q_2(u_2 \mid u_1)(5-6)+q_2(m_2 \mid u_1)(7-6)+q_2(d_2 \mid u_1)(5-6) = 0
    \]
    and \(q_2(u_2 \mid u_1) + q_2(m_2 \mid u_1) + q_2(d_2 \mid u_1)=1\). We have three unknowns and two equations, hence the system is underdetermined! We thus have a family of solutions as \[
        q_2(u_2 \mid u_1) = q, q_2(m_2 \mid u_1) = \frac{1}{2}-\frac{3}{2}q
    \]
    and \(q_2(d_2 \mid u_1) = \frac{1}{2}+\frac{1}{2}q\) where \(q \in (0, 1/3)\) such that \(q_2(\cdot \mid \cdot) \in (0,1)\). This yields \[
        \Q(\set{\omega}) > 0 \iff q \in (0, 1/3) \implies \P \sim \Q.
    \]
    Hence, there exists a bunch of EMMs. Our fundamental theorems yield that this market is free of arbitrage but not complete.
\end{example}

\begin{example}
    We now take a 1-period market with \(B_0=B_1=1\) and two stocks with possible states \color{red}a complicated tree here again. \color{black}

    \(\Omega = \set{u,m,d}\). If \(T=1\), \(q(u)(10-5)+q(m)0+q(d)(2-5)=0\) (stock 1) and \(q(u)(15-10)+q(m)(8-10)+q(d)(12-10)=0\) (stock 2). Our normalisation gives \(q(u)+q(d)+q(m)=1\).

    3 equations, 3 unknowns yields the unique solution \[
        \Q(\set{u})=\frac{6}{41},\quad \Q(\set{m})=\frac{25}{41},\quad \Q(\set{d})=\frac{10}{41}.
    \]
    The total mass is \(1\) and every singleton event has a unique solution. Hence, the EMM is unique, the market is complete and (NA) holds.
\end{example}

\newpage
\section{Risk--neutral pricing of contingent claims}

We will find an explicit formula for the price of specific options. If the claims are not attainable, the arbitrage-free price lies within an interval. We first assume (NA) holds, \(\cF_0=\set{\emptyset, \Omega}\) and \(\cF_T=\cF=2^\Omega\). We know: price of \(t=0\), \(\pi(H)\) is given by the initial value of the corresponding hedging strategy for attainable claims. Otherwise, arbitrage would exist.
In practice, options are dynamically traded and have a price at \underline{any} point in time \(t=0,1,\dots,T\). Price at \(t\) depends on \(S_t\) and is an \(\cF_t\)-measurable random variable. In particular, price at time \(T\) is just \(H\). The price of \(H\) at time \(t\) is just the capital that is needed at time \(t\) (depending on the history) in order to replicate \(H\). If \(\phi\) is a hedging strategy for \(H\), then \(V_t^\phi\) is sufficient to hedge \(H\) from time \(t\) onwards. We now see a generalisation of~\Cref{lem:priceOfAttainableClaims}: \(H\) shows that the price is also unique at time \(t\).
\begin{lemma}[Price of attainable claims, generalisation]\label{lem:priceAttainableClaims2}
    For every attainable claim \(H\) and for self-financing strategies \(\phi\) and \(\psi\) with \(V_T^\phi=H=V_T^\psi\), we have \[
        V_t^\phi=V_t^\psi,\quad \forall t \in \set{0, \dots, T}.
    \]
    \(\pi_t(H)=V_t^\phi\) is the claims price at \(t\).
\end{lemma}
\begin{proof}
    (NA) implies existence of the EMM \(\Q\) and~\Cref{thm:wealthMartingale} yields \(\frac{V_t^{\set{\phi, \psi}}}{B_t}\) are \(\Q\)-martingales. Hence \[
        \frac{V_t^\phi}{B_t}=\E_\Q\left(\frac{V_T^\phi}{B_T} \mid \cF_t\right) = \E_\Q\left(\frac{H}{B_T} \mid \cF_t\right) = \E_\Q \left(\frac{V_T^\psi}{B_T}\mid \cF_t\right)=\frac{V_t^\psi}{B_t}.\qedhere
    \]
\end{proof}

\begin{theorem}[Risk-neutral pricing theorem]\label{thm:riskNeutralPricing}
    Let \(H\) be an attainable claim. Then, for the price of \(H\) at time \(t\) we have \[
        \pi_t(H) = B_t \E_\Q \left(\frac{H}{B_T} \mid \cF_t\right)
    \]
    for any \(\Q \in \cM^+\). In particular, \(\pi_t(H)\) is independent of the choice of \(\Q\).
\end{theorem}
\begin{proof}
    \(H\) is attainable, hence there is a self-financing trading strategy \(\phi=(\alpha, \beta)\) such that \(H=V_T^\phi\). We assume (NA), hence \(\cM^+ \neq \emptyset\). Let \(\Q \in \cM^+\) and use~\Cref{thm:wealthMartingale} to obtain that \(V_t^\phi/B_t\) is a \(\Q\)-martingale. Then \[
        \pi_t(H) = V_t^\phi = B_t \E_\Q \left(\frac{V_T^\phi}{B_T} \mid \cF_t\right) = B_t \E_\Q \left( \frac{H}{B_T} \mid \cF_t \right)
    \]
\end{proof}
\begin{corollary}
    Let \(H\) be an attainable claim, then \(\pi(H) = \pi_0(H) = \E_\Q \left(\frac{H}{B_T}\right)\) for all \(\Q \in \cM^+\).
\end{corollary}
\begin{proof}
    \Cref{thm:riskNeutralPricing} with \(\cF_0=\set{\emptyset, \Omega}\) and \(B_0=1\).
\end{proof}
\begin{proof}[Alternative proof (for fun)]
    \(H\) is attainable means there is a self-financing trading strategy with \(\phi=(\alpha, \beta)\) with \[
        \frac{V_T^\phi}{B_T}=\frac{H}{B_T}=V_0^\phi+G_T^\alpha.
    \]
    (NA) implies there is \(\Q \in \cM^+\) with \(\E_\Q(G_T^\alpha)=0\). Now, \[
        \E_\Q\left(\frac{H}{B_T}\right)=V_0^\phi+\E_\Q(G_T^\alpha)=V_0^\phi=\pi(H).\qedhere
    \]
\end{proof}

\begin{remark}
    If a contingent claim is a linear combination of other contingent claims as \(H=\lambda_1 H_1 + \lambda_2 H_2\) with \(H_1,H_2\) attainable with \(H_i/B_T=V_0^i+G_T^{\alpha_i}\) yields \(H/B_T=V_0+G_T^\alpha\) with \(V=\lambda_1 V_0^1+\lambda_2 V_0^2\) and \(\pi(H)=\lambda_1 \pi(H_1)+\lambda_2 \pi(H_2)\) and \(\alpha = \lambda_1 \alpha_1 + \lambda_2 \alpha_2\).
\end{remark}

\subsection{RA-Call-Parity and Option Portfolios}
\subsubsection{Put-Call-Parity}
Consider two portfolios \(A\) and \(B\):
\begin{table}[hp]
    \begin{center}
        \begin{tabular}{c | c | c | c}
            Portfolio A & Portfolio A & Portfolio B & Portfolio B\\
            \hline
            Action at \(t=0\) & Payoff at \(t=T\) & Action at \(t=0\) & Payoff at \(t=T\)\\
            \hline
            Buy a call & \((S_T-K)^+\) & Buy a put & \((K-S_T)^+\) \\
            \hline
            \(K/B_T\) in riskless asset & K & Buy one stock & \(S_T\) \\
            \hline
            Costs: \(C+K/B_T\) & Payoff:  \((S_T-K)^++K\) & \(P+S_0\) & Payoff: \((K-S_T)^++S_T\)
        \end{tabular}
    \end{center}
\end{table}

\((S_T-K)^++K=\max(K,S_T)=(K-S_T)^++S_T\). \Cref{lem:priceOfAttainableClaims}: if (NA) holds, then the price \(\pi(H)\) of attainable claims is uniquely determined, independent of the choice of hedging strategy.

Portfolio A and B have to have the same price at time \(t=0\). \Cref{thm:riskNeutralPricing} yields \(C+K/B_T=P+S_0\). In particular, \(C_t+K B_t/B_T = P_t + S_t\).

The put-call parity is solely based on (NA). It is independent of the market-model.

It holds only if call and put have the same strike \(K\) and maturity \(T\)!

\subsubsection{Spreads}
Spreads are a combination of two calls or two puts with \emph{different times to maturity (horizontal spread)} or \emph{different strike price (vertical spread)}.

\begin{example}[(Vertical) Bull Spread]
    Net payoff of a bull spread based on 2 puts. Net payoff: \(H-\pi(H)B_T\).

    \color{red}Some graphs go here.\color{black}

    Net payoffs of \(\pi_1^P\), resp.\ \(\pi_2^P\): \((K_i-S_T)^+-\pi_i^P B_T\).
\end{example}

\begin{example}[Straddles]
    Combination of a call and put with the same strike price \(K\) and maturity \(T\).
    \begin{itemize}
        \item Buy both options: Long straddle,
        \item Sell both options: Short straddle.
    \end{itemize}
    \color{red}Some graph here.\color{black}
\end{example}

\subsection{Exotic Options}
European put/call options are so-called plain vanilla options. All other options are exotic. Here: consider options that depend on the maximum of the stock price.

\begin{example}[Standard]
    \begin{itemize}
        \item Up-and-in call option: \[
            H_{u_i}^{\text{call}} = \begin{cases}
                (S_T-K)^+, &S_t \geq B\,\ \forall 0 \leq t \leq T\\
                0 &\text{else}.
        \end{cases}
    \]
        \item Up-and-out call option: \[
            H_{u_o}^{\text{call}} = \begin{cases}
                0 &\max_{0 \leq t \leq T} S_t \geq B\\
                (S_T-K)^+ &\text{else}.
            \end{cases}
        \]
        \item Look-back-put: \[
            H_{max}^{\text{put}} = \max_{0 \leq t \leq T} S_t - S_T.
        \]
        \item Barrier options:
        (a) Knock-in, (b) Knock-out.
    \end{itemize}
\end{example}

\subsubsection*{Digression: Random Walks} Let \((Z_t)\) denote a \emph{symmetric random walk} on \(\mathbb Z\), i.e.\ \(Z_0=0\) and \(Z_t = \sum_{k=1}^t Y_k\) where \((Y_k)\) are i.i.d.\ random variables such that \(\P(Y_k=1)=\P(Y_k=-1)=\frac{1}{2}\). Hence, is equally probable in each point in time to take a step forward or backward. We only consider random walks up to time \(T\). Each realisation \((y_1, \dots, y_T) \in \set{\pm 1}^T = \Omega\) of \((Y_1,\dots,Y_T)\) has the same probability \(1/2^T\).

\begin{lemma}[Random Walk 1]\label{lem:randomWalk1}
    For \(t \in \N\) and \(b\) such that \(-T \leq b \leq T\). We have \[
        \P(Z_T=b) = \begin{cases}
            \frac{1}{2^T} {T \choose (T+b)/2} &T, b \text{ have the same parity}\\
            0 &\text{else}.
        \end{cases}
    \]
\end{lemma}
\begin{remark}
    \(T,b\) have the same parity if they are even or uneven at the same time.
\end{remark}
\begin{proof}
    If we start from point \(0\) at time \(0\) and we want to reach \(b \geq 0\) at time \(T\), then we need to have \(b \geq 0\) more upwards movements than downward movements. Hence, there are \(\frac{T-b}{2}\) downward movements and \(\frac{T-b}{2}+b > \frac{T-b}{2}\) upwards movements. If \(\frac{T-b}{2} \in \N\), \(T, b\) need to have the same parity, otherwise \(\frac{T-b}{2} \notin \N_0\). The number of paths from 0 at time \(0\) to point \(b\) at \(T\) is equal to the number of possibilities to distribute the \(\frac{T-b}{2}\) downward movements. We have \({T \choose \frac{T-b}{2}} = {T \choose \frac{T+b}{2}}\) possibilities. As all paths are equally probable, the claim follows. If \(b < 0\), similar arguments hold.
\end{proof}

Let now \(M_t = \max \set{Z_1, \dots, Z_t}\) denote the running maximum.

\begin{lemma}[Random Walk 2, Reflection Principle]\label{lem:reflection}
    For \(k \in \N\) and \(m \in \N_0\) , we have \[
        \P(M_T \geq k, Z_T = k - m) = \P(Z_T = k + m)
    \]
\end{lemma}
\begin{proof}
    For every path from \(0\) at time \(0\), with \(M_T \geq k\) and \(Z_T = k - m\), there exists one unique path with \(M_T \geq k\) and \(Z_T = k + n\). For this, reflect at the horizontal axis \(y=k\) when reaching \(k\) for the first time. (Drawing)
\end{proof}
\subsubsection{Barrier options in the CRR model.}
We can use the risk-neutral pricing formula from \ref{thm:34} model:
\[
    \pi(H) = \beta_0 B_0 + \alpha_0 S_0 = \sum_{\omega = (y_1,\dots,y_T) \in \Omega} q_{y_1} \cdot \cdots \cdot q_{y_T} \frac{H(\omega)}{B_T} = \E_\Q\frac{H}{B_T}
\]
where \(\Q(\set{\omega})=q_{y_1}\cdot \cdots \cdot q_{y_T}\) and \[
    q_{y_t}= \begin{cases}
        q &y_t=u\\
        1-q &y_t=d
    \end{cases}\quad q = \frac{1+r-d}{u-d}.
\]
The random variables \(Y_1, \dots, Y_T\) are i.i.d.\ with \(\Q(\set{Y_t=u})=q=1-\Q(\set{Y_t=d})\) and \(S_t = S_0 \prod_{k=1}^t Y_k\) for \(t=1,\dots,T\). As the payoff depends on the path, the sum consists of \(2^T = \abs[\Omega]\) summands.
\underline{But}, using results on random walks in \underline{specific} CRR models, we can reduce the number of summands notably. Hence, we want to consider now a specific \(T\)-period CRR model for which we obtain explicit formulas.

Assume \(d=1/u\) and \(1/u < 1 + r < u\) which yields (NA) and completeness.
Let \((Z_t)\) be a symmetric random walk on \(\mathbb Z\). The connection between the price process of the stock and the random walk is the following: if \((Z_t)\) counts \(+1\), the price increases and \(-1\) if the price decreases. Then \(Z_t\) is the sum of upwards and downwards movements. We can write \[
    S_t = S_0 \prod_{n=1}^t Y_n = S_0 u^{\frac{t+Z_t}{2}}d^{\frac{t-Z_t}{2}} = S_0 u^{\frac{t+Z_t}{2}-\frac{t-Z_t}{2}} = S_0 u^{Z_t}.
\]
\begin{example}
    Up-and-in call option \[
        H_{ui}^{call} = (S_T-K)^+ \indic[\max_{0 \leq t \leq T} S_t \geq B]
    \]
    with \(K > 0\) strike price and \(B > \max\set{S_0, K}\) a given barrier. The goal is to compute \(\pi(H_{ui}^{call}) = \E_\Q\frac{H_{ui}^{call}}{(1+r)^T}\). We have \begin{align*}
        \E_\Q\left(H_{ui}^{call}\right)&=\E_\Q (S_T-K)^+ \indic[\max_{0 \leq t \leq T} S_t \geq B]\\
        &=\underbrace{\E_\Q \left( (S_T-K)^+ \indic[S_T \geq B] \right)}_{\text{European option of type } H=h(S_T)} + \underbrace{\E_\Q \left( (S_T-K)^+ \indic[\max_{0 \leq t \leq T} S_t \geq B, S_T < B] \right)}_{\text{Need joint distribution of }S_T\text{ and }\max_{0 \leq t \leq T} S_t\text{ under }\Q.}
    \end{align*}
    \Cref{cor:priceViaBinomialSum} and \(S_T \geq B\) yield \(S_T \geq K\) and we can omit the positive part. Now, we use~\Cref{lem:shouldBe62}. Assumption: the barrier corresponds to exactly one possible stock price, i.e.\ \(B=S_0u^{k_b}\), \(k_b \in \N\). \(S_T < B\) is the case if and only if \(S_0u^{Z_T} < S_0 u^{k_b} \iff Z_T < k_b\). Similarly, \[
        \max \set{S_0, \dots, S_T} \geq B \iff S_0u^{M_T} \geq S_0 u^{k_b} \iff M_T \geq k_b.
    \]
    Thus, we obtain for the second part of the pricing formula (using that \(T\) and \(m+k_b\) have the same parity when \(T+m+k_b\) is even): \[
        \E_\Q\left( (S_T-K)^+ \indic[\max_0 \leq t \leq T] S_t \geq B, S_t < B \right) = \E_\Q \left( (S_0u^{Z_T}-K)^+\indic[M_T \geq k_b, Z_T < k_b] \right).
    \]
    Write this such that~\Cref{lem:shouldBe62} is applicable. The above is equal to \begin{align*}
        &\sum_{m=1, T+m+k_b \text{ even}}^{T-k_b} \E_\Q\left((S_0u^{Z_T}-K)^+ \indic[M_T \geq k_b, Z_T=k_b-m]\right)\\
        &= \sum_{m=1, T+m+k_b \text{ even}}^{T-k_b} (S_0u^{k_b-m}-K)^+ \Q(M_T \geq k_b, Z_T=k-m)\\
        &= \sum_{m=1, T+m+k_b \text{ even}}^{T-k_b} (S_0u^{k_b-m}-K)^+ {T \choose (T+k_b+m)/2} q^{(T+k_b+m)/2}(1-q)^{(T+k_b+m)/2}\\
        &= \left(\frac{q}{1-q}\right)^{k_b} \sum_{m=1, T+m+k_b \text{ even}}^{T-k_b} (S_0u^{k_b-m}-K)^+ {T \choose \frac{T-k_b-m}{2}}q^{(T-k_b-m)/2}(1-q)^{T+k_b+m}\\
        &= \left(\frac{q}{1-q}\right)^{k_b} \sum_{n=0}^T (S_0u^{2k_b-T+2n}-K)^+ {T \choose n} q^n (q-1)^{T-n}
    \end{align*}
    In total, using \(S_T \geq B\) and~\Cref{cor:priceViaBinomialSum} with \(\underline{n} = \min \set{n > (T-k_b)/2}\), we get \begin{align*}
        \pi_{ui}^{call} = \frac{1}{(1+r)^T} \E_\Q H_{ui}^{call} &= \frac{1}{(1+r)^T} \sum_{n=\underline{n}}^T (S_0u^{2n-T}-K)^+ {T \choose n} q^n (1-q)^{T-n}\\
        &+ \left(\frac{q}{1+q}\right)^{k_b} \sum_{n=0}^T (S_0u^{2n-T+2k_b}-K)^+ {T \choose n} q^n (1-q)^{T-n}.
    \end{align*}
    Number of summands is at most \(T\) now. Cool!
\end{example}

\begin{example} Up-and-out-call-option: \[
        H_{uo}^{call} = \begin{cases}
            0 &M_T \geq B\\
            (S_T-K)^+ &\text{else}.
        \end{cases}
    \]
    \(K>0\) and \(B>\max(S_0,K)\). Moreover \[
        H^{call}=(S_T-K)^+
    \]
    is the payoff of the vanilla call. \(H^{call} = H_{ou}^{call}+H_{ui}^{call}\) and hence \[
        \pi(H_{uo}^{call})=\pi(H^{call})-\pi(H_{ui}^{call}).
    \]
    Lookback options: strike \(K\) is traded for its maximum or minimum. Now, we sell for the maximum price \[
        H_{max}^{put} = \max_{0 \leq t \leq T} (S_t) - S_T.
    \]
    Thus \[
        \pi(H_{max}^{put})=\E_\Q \frac{M_T-S_T}{(1+r)^T} = \E_\Q \frac{M_T}{(1+r)^T}-S_0.
    \]
    Now \begin{align*}
        \E_\Q \max S_t &= \E_\Q \max S_0 u^{Z_t} = \E_\Q S_0 u^{\max Z_t} = \E_\Q S_0 u^{M_T} = \sum_{n=0}^T S_0 u^n \Q(M_T=n)\\
        &= \sum_{n=0}^T \sum_{\ell=0}^T S_0 u^n \Q(M_T=n, Z_T=n-\ell)\\
        &= \sum_{n=0}^T \sum_{\ell=0}^T S_0 u^n {T+1 \choose (T-n+\ell)/2} \frac{n+\ell+1}{T+1} q^{(T+n-\ell)/2}(1-q)^{(T-n+\ell)/2}.
    \end{align*}
\end{example}

\begin{lemma}\label{lem:shouldBe62}
    Under \(\Q\), we have for the random walk on \(\mathbb Z\) and it's running maximum \(M_t\) and \(k \in \N\) and \(m \in \N_0\) that \(T\) and \(k+m\) have the same parity: \begin{itemize}
        \item \(\Q(M_T \geq k, Z_T=k-m)={T \choose (T+k+m)/2} q^{(T+k-m)/2}(1-q)^{(T-k+m)/2}\).
        \item \(\Q(M_T=k,Z_T=k-m)={T+1 \choose (T-k+m)/2}\frac{k+m+1}{T+1}q^{(T+k-m)/2}(1-q)^{(T-k+m)/2}\).
    \end{itemize}
\end{lemma}
\begin{proof}
    Use (without proof) that
    \[
        \frac{\Q(\set{\omega})}{\P(\set{\omega})} = 2^T q^{(T+Z_T(\omega))/2}(1-q)^{(T-Z_T(\omega))/2}.
    \]
    Now apply~\Cref{lem:reflection} and~\Cref{lem:randomWalk1}: \begin{align*}
        \Q(M_T \geq k, Z_T=k-m)&=\sum_{F = \set{\omega: M_T(\omega) \geq b, Z_T(\omega)=k-m}} \Q(\set{\omega})\\
        &= 2^T q^{(T+k-m)/2}(1-q)^{(T-k+m)/2}\sum_{F} \P(\set{\omega})\\
        &= 2^T q^{(T+k-m)/2}(1-q)^{(T-k+m)/2}\P(Z_T=k+m)\\
        &= 2^T \frac{1}{2^T} q^{(T+k-m)/2}(1-q)^{(T-k+m)/2} {T \choose (T+k+m)/2},
    \end{align*}
    which shows (a). For (b), we plug in \(\Q(M_T=k,Z_T=k-m)=\Q(M_T \geq k, Z_T=k-m)-\Q(M_T \geq k+1, Z_T=k+1-(m+k)=k-m)\).
\end{proof}

\subsection{Pricing incomplete markets}
We assume a finite financial market such that (NA) holds but not every contingent claim must be attainable, i.e.\ the market is in general incomplete.
\begin{definition}[Superhedging]\label{def:superhedging}
    Let \(H\) be a contingent claim. A self-financing trading strategy \(\phi\) is called superhedging if \(V_T^\phi \geq H\).
\end{definition}
By \[
        \pi_+(H) = \inf \set{V_0^\phi : \phi \text{ is superhedging}}
    \]
we denote the smallest initial investment such that the trading strategy is superhedging (it superreplicates \(H\)). Recall \(V_0^\phi + G_T^\alpha=\frac{V_T^\phi}{B_T}\) and hence \(\pi_+(H) \geq \E_\Q H/B_T\) since \(V_T^\phi \geq H\). Now, \[
    \pi_-(H) = \sup \set{V_0^\phi : \phi \text{ is self-financing and }V_T^\phi \leq H}.
\]
Analogously, \(\pi_-(H) \leq \E_\Q H/B_T\) and hence \(\pi_- \leq \pi_+\). A price for \(H\) that does not allow arbitrage has to be within the open interval \((\pi_-(H), \pi_+(H))\).

If the price lies outside this interval, there is arbitrage. To see this, assume \(\pi(H) > \pi_+(H)\). Then we sell the option for \(\pi(H)\) and realise with \(\pi_+(H)\) a super-hedging strategy. As \(\pi(H) - \pi_+(H) > 0\). We invest this difference in the bond. This yields a riskless gain. Assume otherwise that \(\pi(H) < \pi_-(H)\). Then we sell the option for \(\pi(H)\) and realise with \(\pi_-(H)\) a subhedging strategy. Since \(-(\pi(H)-\pi_-(H)) > 0\), we invest this difference in the bond and again have a riskless gain. Overall, we have\[
    \pi_-(H) \leq \inf_{\Q \in \cM} \E_\Q \frac{H}{B_T} \leq \sup_{\Q \in \cM} \E_\Q \frac{H}{B_T} \leq \pi_+(H).
\]

\section{American options}
\section{Portfolio optimization}

\end{document}